<!doctype html>
<html lang="en">
<head>
<style id="hse-overrides">
  /* Header/banner = HSE green */
  header{
    background: var(--hse-green-700) !important;
    color:#fff !important;
  }

  /* Pills/badges = white chip with green text/border */
  .pill{
    background:#fff !important;
    color: var(--hse-green-700) !important;
    border:1px solid var(--hse-green-700) !important;
  }
  .pill.danger{
    background:#fff !important;
    color:#991b1b !important;
    border-color:#991b1b !important;
  }
  .badge{
    background:#fff !important;
    color: var(--hse-green-700) !important;
    border:1px solid var(--hse-green-700) !important;
  }

  /* Tabs: active state in HSE green for consistency */
  .tab.active{
    background: var(--hse-green-700) !important;
    border-color: var(--hse-green-700) !important;
    color:#fff !important;
  }
</style>

  <meta charset="utf-8">
  <title>CarePlanner v2 — HSE Psychiatric ICP (Unified Inpatient↔Outpatient)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="theme-color" content="#02594C"> <!-- matches --hse-green-700 -->
  <link rel="icon" href="data:,">
  <style>
    :root { --bg:#f6f8fb; --ink:#1a1f2b; --muted:#6b7280; --pri:#0a5b7a; --ok:#2f855a; --warn:#9a3412; --bad:#b91c1c; --card:#ffffff; }
    html,body{margin:0;padding:0;background:var(--hse-bg-tint);color:var(--hse-text);font:19px/1.5 Arial,"Helvetica Neue",Helvetica,sans-serif} 
    header{position:sticky;top:0;background:#0a5b7a;color:#fff;padding:10px 12px;z-index:1000}
    header h1{margin:0;font-size:18px}
    .bar{display:flex;gap:8px;align-items:center;margin-top:6px;flex-wrap:wrap}
    .badge{padding:2px 8px;border-radius:999px;background:#0e7490}
    .container{max-width:1100px;margin:16px auto;padding:0 12px 80px}
    .tabs{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px}
    .tab{padding:8px 10px;border-radius:8px;background:#e2e8f0;color:#0f172a;cursor:pointer;border:1px solid #cbd5e1}
    .tab.active{background:#0a5b7a;color:#fff;border-color:#0a5b7a}
    .panel{display:none}
    .panel.active{display:block}
    .card{background:var(--card);border:1px solid #e5e7eb;border-radius:10px;padding:12px;margin:10px 0}
    label{display:block;margin:8px 0 4px;font-weight:600}
    input,select,textarea{width:100%;padding:8px;border:1px solid #cbd5e1;border-radius:8px;background:#fff}
    textarea{min-height:84px}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
    .col-6{grid-column:span 6} .col-4{grid-column:span 4} .col-3{grid-column:span 3} .col-8{grid-column:span 8} .col-12{grid-column:span 12}
    .btn{appearance:none;border:1px solid #0a5b7a;background:#0a5b7a;color:#fff;border-radius:8px;padding:8px 10px;cursor:pointer}
    .btn.secondary{background:#fff;color:#0a5b7a}
    .btn.warn{background:#9a3412;border-color:#9a3412}
    .stack{display:flex;gap:8px;flex-wrap:wrap}
    .note{color:var(--muted);font-size:0.88rem}
    #unsavedBanner{position:sticky;bottom:0;left:0;right:0;background:#fde68a;color:#78350f;padding:8px 12px;border-top:1px solid #f59e0b}
    .hidden{display:none !important}
    .tag{display:inline-block;padding:2px 6px;border:1px solid #cbd5e1;border-radius:999px;font-size:.8rem;background:#f8fafc;margin:2px 4px 0 0}
    .result{padding:6px;border:1px solid #e5e7eb;border-radius:8px;margin-top:6px;cursor:pointer}
    .result:hover{background:#f1f5f9}
    .danger{color:var(--bad)}
    .section-title{margin-top:0}
    /* Print: composite ICP */
    @media print{
      header,.tabs,#unsavedBanner,.no-print{display:none !important}
      body{background:#fff}
      .panel{display:block !important}
      .card{page-break-inside:avoid}
      .print-section{margin:12px 0;border-top:2px solid #000;padding-top:8px
      /* --- print polish (risk tables) --- */
	  .print-section table { font-size: 11px; }
	  .print-section h4 { margin: 6px 0 4px; }
    }
    /* Unlock banner */
    #lockBar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    #lockBar input{width:auto}
  </style>

<style id="hse-brand-tokens">
  :root{
    /* Typography stays Arial (per HSE) */
    --hse-font: Arial, "Helvetica Neue", Helvetica, sans-serif;

    /* Text & base */
    --hse-text: #212B32;              /* $hse-text-color = $color_hse-grey-900 */
    --hse-text-secondary: #455C68;    /* $hse-secondary-text-color = $color_hse-grey-700 */
    --hse-bg-tint: #F3F3F3;           /* $color_hse-grey-50 (page background tint) */
    --hse-bg-white: #FFFFFF;          /* $color_hse-white-0 */
    --hse-border: #AEB7BD;            /* $hse-border-color = $color_hse-grey-300 */

    /* Links */
    --hse-link: #0B55B7;              /* $hse-link-color = $color_hse-blue */
    --hse-link-hover: #782CC3;        /* $hse-link-hover-color = $color_hse-purple-500 */
    --hse-link-visited: #5F3DC4;      /* $hse-link-visited-color = $color_hse-purple-700 */
    --hse-link-active: #0B55B780;     /* $hse-link-active-color (shade of link) */

    /* Focus */
    --hse-focus-bg: #73E6C2;          /* $hse-focus-color = $color_hse-green-300 */
    --hse-focus-text: #212B32;        /* $hse-focus-text-color = $color_hse-grey-900 */
    --hse-focus-width: 3px;

    /* Buttons (HSE primary = purple family) */
    --hse-btn-primary: #5F3DC4;       /* $hse-button-color = $color_hse-purple-700 */
    --hse-btn-primary-hover: #782CC3; /* $hse-button-hover-color = $color_hse-purple-500 */
    --hse-btn-primary-text: #FFFFFF;  /* $hse-button-text-color = $color_hse-white-0 */
    --hse-btn-disabled-bg: #D8DDE0;   /* $hse-button-disabled-color = $color_hse-grey-100 */
    --hse-btn-disabled-text: #768692; /* $hse-button-disabled-text-color = $color_hse-grey-500 */

    /* Secondary button (outlined purple) */
    --hse-btn-secondary-border: #5F3DC4;         /* $hse-secondary-button-border-color */
    --hse-btn-secondary-hover-border: #782CC3;   /* $hse-secondary-button-hover-color */
    --hse-btn-secondary-text: #5F3DC4;           /* $hse-secondary-button-text-color */
    --hse-btn-secondary-text-hover: #782CC3;     /* $hse-secondary-button-hover-text-color */

    /* Status colours (forms / alerts) */
    --hse-error: #B30638;             /* $hse-error-color = $color_hse-red-500 */
    --hse-warn:  #FFDE0E;             /* $color_hse-yellow-500 */

    /* Palette refs (if needed elsewhere) */
    --hse-green-900:#00473E; --hse-green-700:#02594C; --hse-green-500:#02A78B; --hse-green-300:#73E6C2; --hse-green-100:#80FFD8; --hse-green-50:#ECFBF6;
    --hse-grey-900:#212B32; --hse-grey-700:#455C68; --hse-grey-500:#768692; --hse-grey-300:#AEB7BD; --hse-grey-100:#D8DDE0; --hse-grey-50:#F3F3F3;
    --hse-blue-500:#0B55B7;
    --hse-purple-700:#5F3DC4; --hse-purple-500:#782CC3; --hse-purple-300:#AA37E0;
    --hse-red-500:#B30638;
    --hse-yellow-500:#FFDE0E;
  }
  html, body { font-family: var(--hse-font); color: var(--hse-text); background: var(--hse-bg-tint); }
</style>

<!-- ===== HSE SPACING UTILITIES (responsive, units 0–9) ===== -->
<style id="hse-spacing">
  /* Base scale from the manual:
     Large screens: 0,4,8,16,24,32,40,48,56,64
     Small screens: 0,4,8,8,16,24,32,40,48,56  */
  :root{
    --hse-s0-lg:0px;  --hse-s1-lg:4px;  --hse-s2-lg:8px;  --hse-s3-lg:16px; --hse-s4-lg:24px;
    --hse-s5-lg:32px; --hse-s6-lg:40px; --hse-s7-lg:48px; --hse-s8-lg:56px; --hse-s9-lg:64px;

    --hse-s0-sm:0px;  --hse-s1-sm:4px;  --hse-s2-sm:8px;  --hse-s3-sm:8px;  --hse-s4-sm:16px;
    --hse-s5-sm:24px; --hse-s6-sm:32px; --hse-s7-sm:40px; --hse-s8-sm:48px; --hse-s9-sm:56px;
  }

  /* Small first */
  :root{
    --hse-s0:var(--hse-s0-sm); --hse-s1:var(--hse-s1-sm); --hse-s2:var(--hse-s2-sm); --hse-s3:var(--hse-s3-sm); --hse-s4:var(--hse-s4-sm);
    --hse-s5:var(--hse-s5-sm); --hse-s6:var(--hse-s6-sm); --hse-s7:var(--hse-s7-sm); --hse-s8:var(--hse-s8-sm); --hse-s9:var(--hse-s9-sm);
  }
  /* Promote to “large” at ~768px (tweak this if HSE publishes a different breakpoint) */
  @media (min-width: 768px){
    :root{
      --hse-s0:var(--hse-s0-lg); --hse-s1:var(--hse-s1-lg); --hse-s2:var(--hse-s2-lg); --hse-s3:var(--hse-s3-lg); --hse-s4:var(--hse-s4-lg);
      --hse-s5:var(--hse-s5-lg); --hse-s6:var(--hse-s6-lg); --hse-s7:var(--hse-s7-lg); --hse-s8:var(--hse-s8-lg); --hse-s9:var(--hse-s9-lg);
    }
  }

  /* Margin / padding on all sides */
  .hse-u-margin-0 { margin: var(--hse-s0)!important; }  .hse-u-padding-0 { padding: var(--hse-s0)!important; }
  .hse-u-margin-1 { margin: var(--hse-s1)!important; }  .hse-u-padding-1 { padding: var(--hse-s1)!important; }
  .hse-u-margin-2 { margin: var(--hse-s2)!important; }  .hse-u-padding-2 { padding: var(--hse-s2)!important; }
  .hse-u-margin-3 { margin: var(--hse-s3)!important; }  .hse-u-padding-3 { padding: var(--hse-s3)!important; }
  .hse-u-margin-4 { margin: var(--hse-s4)!important; }  .hse-u-padding-4 { padding: var(--hse-s4)!important; }
  .hse-u-margin-5 { margin: var(--hse-s5)!important; }  .hse-u-padding-5 { padding: var(--hse-s5)!important; }
  .hse-u-margin-6 { margin: var(--hse-s6)!important; }  .hse-u-padding-6 { padding: var(--hse-s6)!important; }
  .hse-u-margin-7 { margin: var(--hse-s7)!important; }  .hse-u-padding-7 { padding: var(--hse-s7)!important; }
  .hse-u-margin-8 { margin: var(--hse-s8)!important; }  .hse-u-padding-8 { padding: var(--hse-s8)!important; }
  .hse-u-margin-9 { margin: var(--hse-s9)!important; }  .hse-u-padding-9 { padding: var(--hse-s9)!important; }

  /* Axis / side-specific utilities per HSE naming guidance */
  .hse-u-margin-top-0{margin-top:var(--hse-s0)!important;}    .hse-u-padding-top-0{padding-top:var(--hse-s0)!important;}
  .hse-u-margin-right-0{margin-right:var(--hse-s0)!important;} .hse-u-padding-right-0{padding-right:var(--hse-s0)!important;}
  .hse-u-margin-bottom-0{margin-bottom:var(--hse-s0)!important;}.hse-u-padding-bottom-0{padding-bottom:var(--hse-s0)!important;}
  .hse-u-margin-left-0{margin-left:var(--hse-s0)!important;}   .hse-u-padding-left-0{padding-left:var(--hse-s0)!important;}

  .hse-u-margin-top-1{margin-top:var(--hse-s1)!important;}    .hse-u-padding-top-1{padding-top:var(--hse-s1)!important;}
  .hse-u-margin-right-1{margin-right:var(--hse-s1)!important;} .hse-u-padding-right-1{padding-right:var(--hse-s1)!important;}
  .hse-u-margin-bottom-1{margin-bottom:var(--hse-s1)!important;}.hse-u-padding-bottom-1{padding-bottom:var(--hse-s1)!important;}
  .hse-u-margin-left-1{margin-left:var(--hse-s1)!important;}   .hse-u-padding-left-1{padding-left:var(--hse-s1)!important;}

  .hse-u-margin-top-2{margin-top:var(--hse-s2)!important;}    .hse-u-padding-top-2{padding-top:var(--hse-s2)!important;}
  .hse-u-margin-right-2{margin-right:var(--hse-s2)!important;} .hse-u-padding-right-2{padding-right:var(--hse-s2)!important;}
  .hse-u-margin-bottom-2{margin-bottom:var(--hse-s2)!important;}.hse-u-padding-bottom-2{padding-bottom:var(--hse-s2)!important;}
  .hse-u-margin-left-2{margin-left:var(--hse-s2)!important;}   .hse-u-padding-left-2{padding-left:var(--hse-s2)!important;}

  .hse-u-margin-top-3{margin-top:var(--hse-s3)!important;}    .hse-u-padding-top-3{padding-top:var(--hse-s3)!important;}
  .hse-u-margin-right-3{margin-right:var(--hse-s3)!important;} .hse-u-padding-right-3{padding-right:var(--hse-s3)!important;}
  .hse-u-margin-bottom-3{margin-bottom:var(--hse-s3)!important;}.hse-u-padding-bottom-3{padding-bottom:var(--hse-s3)!important;}
  .hse-u-margin-left-3{margin-left:var(--hse-s3)!important;}   .hse-u-padding-left-3{padding-left:var(--hse-s3)!important;}

  .hse-u-margin-top-4{margin-top:var(--hse-s4)!important;}    .hse-u-padding-top-4{padding-top:var(--hse-s4)!important;}
  .hse-u-margin-right-4{margin-right:var(--hse-s4)!important;} .hse-u-padding-right-4{padding-right:var(--hse-s4)!important;}
  .hse-u-margin-bottom-4{margin-bottom:var(--hse-s4)!important;}.hse-u-padding-bottom-4{padding-bottom:var(--hse-s4)!important;}
  .hse-u-margin-left-4{margin-left:var(--hse-s4)!important;}   .hse-u-padding-left-4{padding-left:var(--hse-s4)!important;}

  .hse-u-margin-top-5{margin-top:var(--hse-s5)!important;}    .hse-u-padding-top-5{padding-top:var(--hse-s5)!important;}
  .hse-u-margin-right-5{margin-right:var(--hse-s5)!important;} .hse-u-padding-right-5{padding-right:var(--hse-s5)!important;}
  .hse-u-margin-bottom-5{margin-bottom:var(--hse-s5)!important;}.hse-u-padding-bottom-5{padding-bottom:var(--hse-s5)!important;}
  .hse-u-margin-left-5{margin-left:var(--hse-s5)!important;}   .hse-u-padding-left-5{padding-left:var(--hse-s5)!important;}

  .hse-u-margin-top-6{margin-top:var(--hse-s6)!important;}    .hse-u-padding-top-6{padding-top:var(--hse-s6)!important;}
  .hse-u-margin-right-6{margin-right:var(--hse-s6)!important;} .hse-u-padding-right-6{padding-right:var(--hse-s6)!important;}
  .hse-u-margin-bottom-6{margin-bottom:var(--hse-s6)!important;}.hse-u-padding-bottom-6{padding-bottom:var(--hse-s6)!important;}
  .hse-u-margin-left-6{margin-left:var(--hse-s6)!important;}   .hse-u-padding-left-6{padding-left:var(--hse-s6)!important;}

  .hse-u-margin-top-7{margin-top:var(--hse-s7)!important;}    .hse-u-padding-top-7{padding-top:var(--hse-s7)!important;}
  .hse-u-margin-right-7{margin-right:var(--hse-s7)!important;} .hse-u-padding-right-7{padding-right:var(--hse-s7)!important;}
  .hse-u-margin-bottom-7{margin-bottom:var(--hse-s7)!important;}.hse-u-padding-bottom-7{padding-bottom:var(--hse-s7)!important;}
  .hse-u-margin-left-7{margin-left:var(--hse-s7)!important;}   .hse-u-padding-left-7{padding-left:var(--hse-s7)!important;}

  .hse-u-margin-top-8{margin-top:var(--hse-s8)!important;}    .hse-u-padding-top-8{padding-top:var(--hse-s8)!important;}
  .hse-u-margin-right-8{margin-right:var(--hse-s8)!important;} .hse-u-padding-right-8{padding-right:var(--hse-s8)!important;}
  .hse-u-margin-bottom-8{margin-bottom:var(--hse-s8)!important;}.hse-u-padding-bottom-8{padding-bottom:var(--hse-s8)!important;}
  .hse-u-margin-left-8{margin-left:var(--hse-s8)!important;}   .hse-u-padding-left-8{padding-left:var(--hse-s8)!important;}

  .hse-u-margin-top-9{margin-top:var(--hse-s9)!important;}    .hse-u-padding-top-9{padding-top:var(--hse-s9)!important;}
  .hse-u-margin-right-9{margin-right:var(--hse-s9)!important;} .hse-u-padding-right-9{padding-right:var(--hse-s9)!important;}
  .hse-u-margin-bottom-9{margin-bottom:var(--hse-s9)!important;}.hse-u-padding-bottom-9{padding-bottom:var(--hse-s9)!important;}
  .hse-u-margin-left-9{margin-left:var(--hse-s9)!important;}   .hse-u-padding-left-9{padding-left:var(--hse-s9)!important;}

  /* Width override helpers the manual lists */
  .hse-u-width-full{ width:100%!important; }
  .hse-u-width-three-quarters{ width:75%!important; }
  .hse-u-width-two-thirds{ width:66.6667%!important; }
  .hse-u-width-one-half{ width:50%!important; }
  .hse-u-width-one-third{ width:33.3333%!important; }
  .hse-u-width-one-quarter{ width:25%!important; }
</style>
<!-- ===== /HSE SPACING UTILITIES ===== -->

<!-- ===== HSE TYPOGRAPHY (headings, body, overrides) ===== -->
<style id="hse-typography">
  /* Font family (from HSE): Arial first, Helvetica Neue fallback, else sans-serif */
  html, body { font-family: Arial, "Helvetica Neue", Helvetica, sans-serif; }

  /* Headings — use on any heading level to control size */
  .hse-heading-xl{ font-size:64px; line-height:1.1;  margin:0 0 var(--hse-s4); }
  .hse-heading-l { font-size:48px; line-height:1.15; margin:0 0 var(--hse-s4); }
  .hse-heading-m { font-size:32px; line-height:1.2;  margin:0 0 var(--hse-s3); }
  .hse-heading-s { font-size:24px; line-height:1.25; margin:0 0 var(--hse-s3); }
  .hse-heading-xs{ font-size:19px; line-height:1.3;  margin:0 0 var(--hse-s2); }

  /* Paragraph sizes */
  .hse-body   { font-size:19px; line-height:1.5; }   /* default paragraph size */
  .hse-body-l { font-size:24px; line-height:1.5; }   /* lead paragraph — use sparingly, once per page */
  .hse-body-s { font-size:16px; line-height:1.5; }   /* small body; use sparingly */

  /* Font-weight utilities */
  .hse-u-font-weight-normal{ font-weight:400; }
  .hse-u-font-weight-bold  { font-weight:700;  }

  /* Font-size override utilities (use only when needed) */
  .hse-u-font-size-64{ font-size:64px; }
  .hse-u-font-size-48{ font-size:48px; }
  .hse-u-font-size-32{ font-size:32px; }
  .hse-u-font-size-24{ font-size:24px; }
  .hse-u-font-size-22{ font-size:22px; }
  .hse-u-font-size-19{ font-size:19px; }
  .hse-u-font-size-16{ font-size:16px; }
  .hse-u-font-size-14{ font-size:14px; }

  /* Small-screen adjustments for the “body-s” variant per HSE guidance */
  @media (max-width: 767.98px){
    .hse-body-s{ font-size:14px; }
  }
</style>
<!-- ===== /HSE TYPOGRAPHY ===== -->

<!-- ===== HSE THEME START (CarePlanner) ===== -->
<style id="hse-theme-core">
  /* Base font per HSE: Arial first, Helvetica Neue fallback, then sans-serif */
  html, body { font-family: Arial, "Helvetica Neue", Helvetica, sans-serif; }
  /* Body size guidance: default 19px (HSE ‘hse-body’) */
  body { font-size: 19px; line-height: 1.5; color: #0f172a; }

  /* Tokens (override safely later if you import official ones from Figma) */
  :root{
    /* Primary brand (placeholder consistent with CarePlanner’s current use) */
    --hse-green: #006152;
    /* Focus state uses “HSE green 300” + thick black border per manual.
       If you later export tokens, swap this to the official hse-green-300 hex. */
    --hse-focus-bg: #cfeae4;   /* temporary light-green focus fill */
    --hse-focus-text: #000000; /* focus text color */
    --hse-focus-width: 3px;
    /* Link colour from manual example pages */
    --hse-link-blue: #0B55B7;  /* Action link examples show this blue */
    /* Layout */
    --hse-max-page-width: 960px;
  }

  /* Page container width per HSE layout */
  .container, #container, .page, main {
    max-width: var(--hse-max-page-width);
    margin-inline: auto;
  }

  /* HSE headings & body utility classes (lightweight subset mirroring manual) */
  .hse-heading-xl{ font-size: 48px; line-height:1.15; margin: 0 0 16px; }
  .hse-heading-l { font-size: 32px; line-height:1.2;  margin: 0 0 16px; }
  .hse-heading-m { font-size: 24px; line-height:1.25; margin: 0 0 12px; }
  .hse-heading-s { font-size: 19px; line-height:1.3;  margin: 0 0 8px;  }
  .hse-heading-xs{ font-size: 16px; line-height:1.3;  margin: 0 0 6px;  }
  .hse-body     { font-size: 19px; }
  .hse-body-l   { font-size: 24px; }
  .hse-body-s   { font-size: 16px; }
  .hse-u-font-weight-normal{ font-weight: 400; }
  .hse-u-font-weight-bold  { font-weight: 700; }

  /* Lists & links as per HSE typography */
  a.hse-link { color: var(--hse-link-blue); text-decoration: underline; }
  a.hse-link:hover { text-decoration-thickness: 2px; }
  .hse-list{ padding-left: 1.5rem; }
  .hse-list--bullet{ list-style: disc; }
  .hse-list--number{ list-style: decimal; }

  /* Focus states (keyboard accessibility): light-green fill + thick black border.
     Mirrors the manual’s description & mixin behaviour. */
  :where(a, button, [role="button"], input, select, textarea, summary, [tabindex]):focus{
    outline: var(--hse-focus-width) solid transparent;
    box-shadow: 0 4px #111;            /* “thick black” delineation */
    background-color: var(--hse-focus-bg);
    color: var(--hse-focus-text);
  }
  /* Inputs get thicker border on focus (manual guidance) */
  input:focus, select:focus, textarea:focus{
    border-width: 2px !important;
  }

  /* Buttons styled to HSE green with accessible hover */
  .btn{
    background: var(--hse-green); color: #fff; border: none; border-radius: 6px;
    padding: 10px 14px; font-weight: 700;
  }
  .btn:hover{ filter: brightness(0.95); }
  .btn.secondary{
    background: #fff; color: var(--hse-green); border:1px solid var(--hse-green);
  }
  .btn.secondary:hover{ background:#f8fafc; }

  /* Spacing: light util set aligning with HSE responsive scale concept.
     (Exact numbers closely follow NHS/HSE scale; adjust if you later import official utilities.) */
  :root{
    --space-0: 0px; --space-1: 4px; --space-2: 8px; --space-3: 16px;
    --space-4: 24px; --space-5: 32px; --space-6: 40px; --space-7: 48px;
    --space-8: 56px; --space-9: 64px;
  }
  .hse-u-mb-3{ margin-bottom: var(--space-3) !important; }
  .hse-u-mb-4{ margin-bottom: var(--space-4) !important; }
  .hse-u-mb-6{ margin-bottom: var(--space-6) !important; }
  .hse-u-p-3 { padding: var(--space-3) !important; }

  /* Links inside body text */
  p a, li a { color: var(--hse-link-blue); text-decoration: underline; }

  /* Keep your existing print styles; header/footer already added by your script */
</style>
<!-- ===== HSE THEME END (CarePlanner) ===== -->

<style id="hse-secondary-tokens">
  :root{
    /* Secondary accents (placeholders; replace with official secondary palette if provided) */
    --hse-blue: #005EB8;   /* accessible blue for links */
    --hse-blue-hover: #004a90;
    --hse-orange: #F28C28; /* optional accent */
    --hse-purple: #6B5B95; /* optional accent */
  }
  h1,h2,h3{ color: var(--hse-grey-ink); }
  a{ color: var(--hse-blue); text-decoration: underline; }
  a:hover{ color: var(--hse-blue-hover); text-decoration-thickness: 2px; }
</style>

<style id="hse-header-brand">
  header{ display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
header .brand {
  display: flex;
  align-items: center;   /* vertical centering */
  justify-content: flex-start; /* <--- forces left alignment */
  gap: 12px;             /* space between logo and title */
}  
header .hse-mark {
  height: 28px;          /* controls logo size */
  width: auto;
  display: block;
}
header h1 {
  margin: 0;
  font-size: 18px;       /* or whatever heading size you want */
  color: #fff;           /* stays white on HSE green */
}</style>

<style id="hse-header-fixes">
  /* Full-bleed banner in HSE green */
  header{
    position: sticky; top: 0;
    background: var(--hse-green-700) !important; color: #fff !important;
    z-index: 1000; width: 100%; margin: 0; padding: 0;
  }
  /* Constrain the contents to the same width as your page container */
  header .header-inner{
    max-width: var(--hse-max-page-width, 960px);
    margin: 0 auto;
    padding: 10px 12px;
    display: flex; flex-direction: column; gap: 6px;
  }

  /* First row: logo + title */
  header .brand{ display:flex; align-items:center; }
  header .hse-mark{ height: 28px; width:auto; display:block; }
  header h1{ margin:0; font-size:18px; }

  /* Pills/badges (token-aware) */
  .badge{
    background:#fff !important;
    color: var(--hse-green-700) !important;
    border:1px solid var(--hse-green-700) !important;
    border-radius: 999px; padding: 2px 8px;
    font-weight:700;
  }
  .pill{
    background:#fff !important;
    color: var(--hse-text) !important;
    border:1px solid var(--hse-border) !important;
    border-radius:999px; padding:4px 8px;
    font-weight:600;
  }

  /* Tabs active = HSE green */
  .tab.active{
    background: var(--hse-green-700) !important;
    border-color: var(--hse-green-700) !important;
    color:#fff !important;
  }
</style>

<style id="hse-logo-sizes">
  .app-header{ background: var(--hse-green-700); color:#fff; }
  .app-header .header-inner{ max-width: 960px; margin:0 auto; padding:10px 12px; display:flex; flex-direction:column; gap:6px; }
  .app-header .brand{ display:flex; align-items:center; }
  .app-header .hse-mark{
    height:28px;    /* controls size */
    width:auto;
    display:block;
  }
  @media print{
    body[data-print="colour"] .app-header .hse-mark{ height:24px; }
    body[data-print="bw"]     .app-header .hse-mark{ height:24px; filter:none; }
  }
</style>

<style id="hse-pills-fix">
  .brand-row{
    display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
  }
  .info-pills{
    display:flex; align-items:center; gap:8px; flex-wrap:wrap;
  }
</style>

<style id="hse-header-clean">
  /* Full-bleed HSE banner with constrained inner width */
  header.app-header{
    position: sticky; top: 0; z-index: 1000;
    background: var(--hse-green-700) !important; color: #fff !important;
    width: 100%; margin: 0; padding: 0;
  }
  header.app-header .header-inner{
    max-width: var(--hse-max-page-width, 960px);
    margin: 0 auto; padding: 10px 12px;
    display: flex; flex-direction: column; gap: 8px;
  }

  /* Row 1: brand left, pills right */
  .header-row{ display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
  .brand-row{ justify-content: space-between; }
  .brand{ display:flex; align-items:center; gap:12px; min-width:280px; }
  .hse-mark{ height:28px; width:auto; display:block; }
  header.app-header h1{ margin:0; font-size:18px; color:#fff; }
  .info-pills{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }

  /* Row 2 and Row 3 */
  .actions-row{ gap:8px; }
  .nav-row{ gap:6px; }
  .nav-row .tab{
    background:#e2e8f0; color:#0f172a; border:1px solid #cbd5e1;
    border-radius:6px; padding:6px 10px; font-weight:600;
  }
  .nav-row .tab.active{
    background: var(--hse-green-700) !important;
    border-color: var(--hse-green-700) !important; color:#fff !important;
  }

  /* HSE-style chips */
  .pill{
    background:#fff !important; color: var(--hse-text) !important;
    border:1px solid var(--hse-border) !important;
    border-radius:999px; padding:4px 8px; font-weight:600;
  }
  .badge{
    background:#fff !important; color: var(--hse-green-700) !important;
    border:1px solid var(--hse-green-700) !important;
    border-radius:999px; padding:2px 8px; font-weight:700;
  }

  @media print { .no-print{ display:none !important; } }
</style>

<style id="hse-brand-row-nowrap">
  /* Keep Row-1 on a single line on wider screens */
  @media (min-width: 992px){
    .brand-row{ flex-wrap: nowrap !important; }
    .brand{ flex: 1 1 auto; min-width: 0 !important; }         /* let the title shrink */
    .brand h1{
      margin: 0;
      font-size: 18px;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis; /* prevent pushing pills down */
    }
    .info-pills{
      flex: 0 1 auto;
      justify-content: flex-end;
    }
    .info-pills .pill{ white-space: nowrap; }  /* pills don’t break mid-word */
  }

  /* Optional: tighten horizontal gaps slightly so everything fits */
  .brand-row{ column-gap: 10px; row-gap: 6px; }
  .info-pills{ gap: 6px; }
</style>

<!-- Colour print stylesheet -->
<link rel="stylesheet" href="print-colour.css" media="print" id="print-colour">

<!-- Black & white print stylesheet (disabled by default) -->
<link rel="stylesheet" href="print-bw.css" media="print" id="print-bw" disabled>
</head>
<body>

<header role="banner" class="app-header">
  <div class="header-inner">

    <!-- Row 1: Logo + info pills -->
<!-- Row 1: Logo + info pills -->
<div class="header-row brand-row">
  <div class="brand">
    <img id="hseLogo" class="hse-mark" alt="HSE logo" src="assets/hse-logo-white.png">
    <h1>Individual Care Planner</h1>
  </div>

  <div class="info-pills no-print">
    <span class="pill">Doc Hash: <code id="docHash">—</code></span>
    <span class="pill">
      User: <strong id="userName">Local User</strong>
      (<span id="userRole">Clinician</span>)
    </span>
    <span class="pill" id="modeBadge">
      Mode: <strong id="workflowLabel">Inpatient</strong>
    </span>
  </div>
</div>
    <!-- Row 2: Save / Print actions -->
    <div class="header-row actions-row no-print">
      <button class="btn secondary" id="btnExport">Save ICP</button>
      <input type="file" id="fileImport" accept="application/json" hidden>
<button class="btn secondary no-print" id="btnImport">Load ICP</button>
<script>
  document.getElementById('btnImport')?.addEventListener('click', ()=>document.getElementById('fileImport').click());
</script>
  

      <button class="btn" id="btnPrint">Save &amp; Print ICP</button>
      <button class="btn" id="btnPrintColour">Print (colour)</button>
      <button class="btn secondary" id="btnPrintBW">Print (black &amp; white)</button>

      <button class="btn secondary" id="btnCopyHash">Copy Doc Hash</button>
    </div>

    <!-- Row 3: Section navigation -->
<nav class="header-row nav-row no-print" aria-label="CarePlanner sections">
	<button class="tab" data-panel="admission">Admission</button>
	<button class="tab" data-panel="icp">Full ICP</button>
	<button class="tab" data-panel="risk">Risk / Obs &amp; Leave</button>
	<button class="tab" data-panel="review">Reviews</button>
	<button class="tab" data-panel="meds">Medications</button>
	<button class="tab" data-panel="prompts">Policy Prompts</button>
	<button class="tab" data-panel="discharge">Discharge</button>
	<button class="tab" data-panel="audit">Admin</button>
	<button class="tab" data-panel="composite">Composite View</button>
</nav>


  </div>
</header>



<div class="container">
  <!-- Workflow / Episode controls -->
  <div class="card no-print">
    <div class="row">
      <div class="col-4">
        <label>Workflow</label>
        <select id="workflowSel">
          <option value="inpatient">Inpatient</option>
          <option value="outpatient">Outpatient</option>
        </select>
      </div>
      <div class="col-4">
        <label>Episode state</label>
        <select id="stateSel">
          <option>InpatientActive</option>
          <option>InpatientDischargePlanned</option>
          <option>DischargedToCommunity</option>
          <option>CommunityActive</option>
          <option>CommunityReviewDue</option>
          <option>Closed</option>
        </select>
      </div>
      <div class="col-4">
        <label>&nbsp;</label>
        <div class="stack">
          <button class="btn secondary" id="btnHandover">Handover to Community</button>
          <button class="btn secondary" id="btnNewEpisode">New Episode</button>
        </div>
      </div>
      <div class="row no-print">
        <div class="col-6">
          <label>Auth mode</label>
          <select id="msModeSel">
            <option value="local">Local (passphrase)</option>
            <option value="entra">Microsoft (stub)</option>
          </select>
        </div>
        <div class="col-6">
          <label>Note</label>
          <p class="note">Microsoft sign-in is a placeholder here; later we will wire MSAL and Entra app registration.</p>
        </div>
      </div>
      <div class="row no-print">
        <div class="col-12">
          <label class="pill"><input type="checkbox" id="hideNotAllowed" checked> Hide UI not permitted for my role</label>
        </div>
      </div>
    </div>
    <p class="note">These controls drive policy prompts, review cadence, and composite labels. Handover copies active goals/interventions and switches workflow.</p>
  </div>

 

  <!-- PANEL: Admission / Initial -->
  <section class="panel active" id="admission">
    <div class="card">
      <h2 class="section-title">Patient Summary</h2>
      <div class="row">
        <div class="col-6"><label>Name</label><input id="p_name"></div>
        <div class="col-3"><label>DOB</label><input id="p_dob" type="date"></div>
        <div class="col-3"><label>Age</label><input id="p_age" type="number" min="0"></div>
        <div class="col-4"><label>PPSN (optional)</label><input id="p_ppsn" inputmode="text"></div>
        <div class="col-4"><label>Eircode (optional)</label><input id="p_eircode" inputmode="text"></div>
        <div class="col-4"><label>MRN / Local ID</label><input id="p_mrn"></div>
      </div>
    </div>

    <div class="card">
      <h2>Admission / Initial Plan</h2>
      <div class="row">
        <div class="col-4"><label>Episode start</label><input id="ep_start" type="date"></div>
        <div class="col-4"><label>Key worker</label><input id="adm_keyworker"></div>
        <div class="col-4"><label>Consultant psychiatrist</label><input id="adm_consult"></div>
      </div>

      <label>Service-user voice (needs/priorities)</label>
      <textarea id="adm_needs" placeholder='"I feel…", "I want…", include key risks/medical needs.'></textarea>

      <div class="row">
        <div class="col-6"><label>Initial goals (SMART)</label><textarea id="adm_goals"></textarea></div>
        <div class="col-6"><label>Initial interventions & resources</label><textarea id="adm_interventions" placeholder="Bullets are fine; include who does what."></textarea></div>
      </div>

      <div class="row">
        <div class="col-6">
          <label>Co-produced with service user?</label>
          <select id="adm_coprod">
            <option value="yes">Yes</option>
            <option value="no">No (capture reason)</option>
          </select>
          <label>If No: reason & steps taken to encourage involvement</label>
          <textarea id="adm_coprod_reason" placeholder="E.g., too unwell; refusal; steps taken…"></textarea>
        </div>
        <div class="col-6">
          <label>Discharge planning discussed?</label>
          <select id="adm_dc_discussed">
            <option>Yes</option><option>No</option>
          </select>
          <label>Notes (barriers, community supports, target date if known)</label>
          <textarea id="adm_dc_notes"></textarea>
        </div>
      </div>

      <div class="row">
        <div class="col-6">
          <label>Is the service user a child (&lt;18)?</label>
          <select id="is_child"><option>No</option><option>Yes</option></select>
        </div>
        <div class="col-6 child-only hidden">
          <label>Education requirements (if child)</label>
          <textarea id="child_edu"></textarea>
        </div>
      </div>

      <div class="row">
        <div class="col-6"><label>GP name</label><input id="gp_name"></div>
        <div class="col-6"><label>GP Healthmail</label><input id="gp_healthmail" placeholder="name@healthmail.ie"></div>
      </div>
    </div>
  </section>

  <!-- PANEL: Full ICP -->
  <section class="panel" id="icp">
    <div class="card">
      <h2>Full MDT ICP</h2>
      <div class="card" id="serviceUserInvolvement">
		  <h3>Service-user & Carer Involvement</h3>
		  <div class="row">
		    <div class="col-6">
		      <label>Service-user present at ICP?</label>
		      <select id="suPresent">
		        <option>Yes</option><option>No</option><option>Not applicable</option>
		      </select>
		    </div>
		    <div class="col-6">
		      <label>If No/NA, explain</label>
		      <input id="suPresentWhy" placeholder="Reason not present / not practicable">
		    </div>
		  </div>
		  <div class="row">
		    <div class="col-6">
		      <label>Service-user agrees with ICP?</label>
		      <select id="suAgrees">
		        <option>Yes</option><option>No</option><option>Not sure</option>
		      </select>
		    </div>
		    <div class="col-6">
		      <label>If No/Not sure, record view</label>
		      <input id="suDisagreeNote" placeholder="SU views / concerns">
		    </div>
		  </div>
		  <div class="row">
		    <div class="col-6">
		      <label>Copy of ICP offered?</label>
		      <select id="suCopyOffered">
		        <option>Yes</option><option>No</option><option>Deferred</option>
		      </select>
		    </div>
		    <div class="col-6">
		      <label>If No/Deferred, explain</label>
		      <input id="suCopyWhy" placeholder="Reason not given / deferred">
		    </div>
		  </div>
		  <div class="row">
		    <div class="col-6">
		      <label>Carer/family involved?</label>
		      <select id="carerInvolved">
		        <option>Yes</option><option>No</option><option>Not applicable</option>
		      </select>
		    </div>
		    <div class="col-6">
		      <label>Notes (carer involvement / consent)</label>
		      <input id="carerNotes" placeholder="What involvement; consent basis">
		    </div>
		  </div>
		</div>
      <p class="note">Add Goals, link Interventions to a Goal, and note Resources/Owners.</p>
		<div class="card" id="actionsCard">
		  <h2>Care Plan Actions</h2>
		  <table id="actionsTable" border="0" cellspacing="0" cellpadding="6" width="100%">
		    <thead>
		      <tr>
		        <th>#</th>
		        <th>Need</th>
		        <th>Goal</th>
		        <th>Action</th>
		        <th>Responsible</th>
		        <th>Status</th>
		        <th class="no-print">✖︎</th>
		      </tr>
		    </thead>
		    <tbody id="actionsTbody"></tbody>
		  </table>
		  <div class="stack no-print" style="margin-top:8px">
		    <button class="btn" id="btnAddAction">Add Action</button>
		  </div>
		</div>
      <div class="stack">
        <button class="btn" id="btnAddGoal" data-roles="Clinician,Psychiatrist">Add Goal</button>
        <button class="btn secondary" id="btnAddIntervention" data-roles="Clinician,Psychiatrist,Nurse,OT,SW">Add Intervention</button>
        <button class="btn secondary" id="btnAddResource" data-roles="Clinician,Psychiatrist,Nurse,OT,SW">Add Resource</button>
      </div>

      <div id="goals"></div>
      <div id="interventions"></div>
      <div id="resources"></div>
    </div>
  </section>

  <!-- PANEL: Risk / Obs & Leave -->
  <section class="panel" id="risk">
    <div class="card">
      <h2>Observation / Leave</h2>
      <label>Observation / Leave level</label>
      <select id="obsLeave">
        <option>Special 1:1 nursing</option>
        <option>30 minute nursing observations</option>
        <option>Hourly nursing observations</option>
        <option>Accompanied Leave</option>
        <option>Unaccompanied leave</option>
      </select>

      <div id="riskPrompt" class="card hidden" style="border-color:#f59e0b;background:#fff7ed">
        <strong>Risk assessment update required</strong>
        <label>Rationale (why is this change appropriate now? risks, triggers, mitigations)</label>
        <textarea id="riskReason"></textarea>
        <div class="stack">
          <button class="btn" id="btnConfirmRisk" data-roles="Clinician,Psychiatrist">Confirm update</button>
          <button class="btn secondary" id="btnCancelRisk">Cancel</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Risk Notes</h2>
      <label>Latest risk summary</label>
      <textarea id="risk_summary" placeholder="Concise synthesis incl. self-harm/violence risk, medical comorbidity, protective factors."></textarea>
    </div>
    <div class="card" id="riskV4">
  <h2>Structured Risk Assessment (V4)</h2>
  <p class="note">Complete historical (static) and dynamic factors. High-risk items trigger mitigation & sign-off.</p>

  <div id="riskV4Flags" class="card hidden" style="border-color:#b91c1c;background:#fef2f2">
    <strong class="danger">High-risk factors present</strong>
    <p class="note">Mitigation and dual sign-off required before printing.</p>
  </div>

  <h3>Historical / Static</h3>
  <div id="riskV4Static"></div>

  <h3>Dynamic (current)</h3>
  <div id="riskV4Dynamic"></div>

  <h3>Clinical Safety</h3>
  <div id="riskV4Clinical"></div>

  <h3>Protective Factors</h3>
  <div id="riskV4Protective"></div>

  <h3>Summary of risk profile</h3>
  <textarea id="riskV4Summary" placeholder="Synthesis referencing static & dynamic factors."></textarea>

  <h3>Risk mitigation measures</h3>
  <textarea id="riskV4Mitigation" placeholder="Observations, 1:1 nursing, de-escalation, environment, meds, contacts, etc."></textarea>

  <h3>Sign-off</h3>
  <div class="row">
    <div class="col-6"><label>NCHD/Consultant (MCN)</label><input id="riskV4SignMed"></div>
    <div class="col-6"><label>RPN</label><input id="riskV4SignNurse"></div>
  </div>
  <div class="row">
    <div class="col-6"><label>Date (med)</label><input id="riskV4DateMed" type="date"></div>
    <div class="col-6"><label>Date (RPN)</label><input id="riskV4DateNurse" type="date"></div>
  </div>

  <div class="stack no-print" style="margin-top:8px">
    <button class="btn" id="riskV4Save">Save Risk Assessment</button>
  </div>
</div>
  </section>

  <!-- PANEL: Reviews -->
  <section class="panel" id="review">
    <div class="card">
      <h2>Reviews</h2>
      <div class="stack">
        <button class="btn" id="btnAddReview">Add Review</button>
        <span class="pill" id="reviewDue">Review cadence: policy-driven</span>
      </div>
      <div id="mdtOverdue" class="card hidden" style="border-color:#9a3412;background:#ffedd5">
        <strong class="danger">Annual MDT care planning session overdue</strong>
        <p class="note">For outpatients, policy requires at least one MDT care planning session per year.</p>
        <div class="stack"><button class="btn" id="btnReviewIcsMdt">Download MDT .ics Reminder</button></div>
      </div>
      <div id="reviewOverdue" class="card hidden" style="border-color:#b91c1c;background:#fef2f2">
        <strong class="danger">Review overdue</strong>
        <p class="note">Policy says a review is due. Create one now, or generate a calendar reminder.</p>
        <div class="stack">
          <button class="btn secondary" id="btnAddReview2">Add Review Now</button>
          <button class="btn" id="btnReviewIcs">Download .ics Reminder</button>
        </div>
      </div>
      <div id="reviews"></div>
      <p class="note">Record who attended (≥3 disciplines if full MDT not possible), decisions, new/achieved goals, and next review date.</p>
    </div>
  </section>

  <!-- PANEL: Medications -->
  <section class="panel" id="meds">
    <div class="card">
      <h2>Medications</h2>
      <p class="note">Type to search (generic or brand). Click a result to add. Use <em>Stop</em> or <em>Change</em> to update.</p>

      <label>Find medicine</label>
      <input id="medSearch" placeholder="e.g., sertraline, olanzapine 10 mg tablet">
      <div id="medResults"></div>

      <h3 style="margin-top:14px">Current medications</h3>
      <div id="medList"></div>
    </div>

    <div class="card">
      <h3>GP Summary (auto-builds)</h3>
      <div id="medGpSummary"></div>
    </div>
  </section>

  <!-- PANEL: Policy Prompts -->
  <section class="panel" id="prompts">
    <div class="card">
      <h2>Policy-driven Prompts</h2>
      <p class="note">These checklists are driven by the embedded policy JSON below. Edit the JSON to customise per local policy.</p>
      <div id="policyPrompts"></div>
    </div>
    <div class="card">
      <h3>Embedded Policy JSON (edit & save)</h3>
      <div class="stack no-print" style="margin-bottom:6px">
        <button class="btn secondary" id="btnAddPromptIn">+ Inpatient Prompt</button>
        <button class="btn secondary" id="btnAddPromptOut">+ Outpatient Prompt</button>
        <button class="btn secondary" id="btnRemoveLastPrompt">− Remove Last Prompt</button>
      </div>
      <textarea id="policyJson" style="min-height:220px"></textarea>
      <div class="stack no-print" style="margin-top:8px">
        <button class="btn secondary" id="btnPolicyApply">Apply Policy JSON</button>
        <span id="policyStatus" class="pill"></span>
      </div>
    </div>
  </section>

  <!-- PANEL: Discharge -->
  <section class="panel" id="discharge">
    <div class="card">
      <h2>Discharge Planning</h2>
      <div class="row">
        <div class="col-6"><label>Target discharge date</label><input id="dc_date" type="date"></div>
        <div class="card" style="margin-top:8px">
          <h3>Follow-up Appointments</h3>
          <div class="stack no-print" style="margin-bottom:6px">
         <button class="btn secondary" id="btnAddFollow">Add Follow-up</button>
        </div>
       <div id="followList"></div>
       </div>
      </div>
      <label>Discharge plan summary</label>
      <textarea id="dc_plan"></textarea>

      <div class="stack" style="margin-top:8px">
        <button class="btn secondary" id="btnBuildGpPack">Build GP Summary (preview)</button>
        <button class="btn" id="btnDownloadGpHtml">Download GP Summary (HTML)</button>
        <button class="btn" id="btnDownloadIcs">Download Follow-up (.ics)</button>
        <button class="btn secondary" id="btnHealthmail">Open Email Draft (Healthmail)</button>
      </div>
      <div id="gpPackPreview" class="card hidden"></div>
    </div>
  </section>

  <!-- PANEL: Audit/Admin + Composite View -->
  <section class="panel" id="audit">
    <div class="card">
      <h2>Audit Log</h2>
      <div id="auditLog"></div>
      <div class="stack no-print" style="margin-top:8px">
        <button class="btn secondary" id="btnClearLocal">Clear Local Data</button>
        <label class="pill"><input type="checkbox" id="requirePass" checked> Require passphrase for saving</label>
      </div>
      <div class="row no-print">
        <div class="col-6">
          <label>Logged-in user (local demo)</label>
          <input id="userNameInput" value="Local User">
        </div>
        <div class="col-6">
          <label>Role</label>
          <select id="userRoleSel">
            <option>Clinician</option>
            <option>Psychiatrist</option>
            <option>Nurse</option>
            <option>OT</option>
            <option>Social Worker</option>
            <option>Admin</option>
          </select>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>ICP Quality Checklist (complete before printing)</h2>
    <div class="card no-print">
      <h2>Shared-Drive Helpers</h2>
      <p class="note">Use when saving to a shared drive. First click <em>Save Encrypted Bundle</em> (header), then place the file in the unit’s pilot folder.<br>
      To prevent clashes, create a <strong>lock</strong> file before editing and delete it when finished.</p>
      <div class="stack">
        <button class="btn secondary" id="btnCreateLock2">Create Lock File</button>
        <button class="btn secondary" id="btnReleaseLockInfo">Release Lock (instructions)</button>
      </div>
      <div id="lockInfo" class="note"></div>
    </div>

      <label><input type="checkbox" id="qc_interim"> Interim ICP completed on admission/initial</label>
      <label><input type="checkbox" id="qc_7day"> Full MDT ICP completed by policy</label>
      <label><input type="checkbox" id="qc_reviews"> Reviews at required cadence</label>
      <label><input type="checkbox" id="qc_coprod"> Co-production recorded or reason captured</label>
      <label><input type="checkbox" id="qc_composite"> Composite print includes all sections</label>
    </div>
  </section>

  <!-- PANEL: Composite (print view) -->
  <section class="panel" id="composite">
    <div class="card">
      <h2>Composite ICP (Print View)</h2>
      <div class="stack no-print" style="margin:8px 0">
       <button class="btn" id="btnPrintColour">Print (colour)</button>
       <button class="btn secondary" id="btnPrintBW">Print (black & white)</button>
      </div>
      <div class="no-print" style="margin:8px 0">
        <label class="pill"><input type="checkbox" id="qrToggle" checked> Include QR of document hash on print</label>
      </div>
      <div id="printArea"></div>
      <p class="note">Use “Save & Print ICP” to save (encrypted if enabled) and open the browser print dialog.</p>
    </div>
  </section>

  <div id="unsavedBanner" class="hidden no-print">Current plan differs from the last saved version. Please Save & Print.</div>

<script>
/* ===== HSE THEME MAP START ===== */
(function(){
  // Headings → HSE classes
  document.querySelectorAll('h1')?.forEach(h=>h.classList.add('hse-u-margin-top-7','hse-u-margin-bottom-4'));
  document.querySelectorAll('h2')?.forEach(h=>h.classList.add('hse-u-margin-top-7','hse-u-margin-bottom-4'));
  document.querySelectorAll('h3')?.forEach(h=>h.classList.add('hse-u-margin-top-5','hse-u-margin-bottom-3'));
  // make small helper text use the small body size
  document.querySelectorAll('.note')?.forEach(p=>p.classList.add('hse-body-s'));
  // Body copy blocks you care about
  document.querySelectorAll('p, .card, .stack, .pill')?.forEach(el=>el.classList.add('hse-body'));
  // Links → HSE link style
  document.querySelectorAll('a')?.forEach(a=>a.classList.add('hse-link'));
  // Main container width per HSE
  const pageHost = document.querySelector('.container') || document.querySelector('main');
  if (pageHost) pageHost.classList.add('page');  // do NOT put .page on <body>
})();
 /* ===== HSE THEME MAP END ===== */
</script>

  <!-- Templates -->
  <script id="tpl-goal" type="text/x-template">
    <div class="card" data-id="{{id}}">
      <div class="row">
        <div class="col-8"><label>Goal (service-user voice preferred)</label><input class="g-text" value="{{text}}"></div>
        <div class="col-4">
          <label>Owner / Responsible</label><input class="g-owner" value="{{owner}}">
        </div>
        <div class="col-3"><label>Due</label><input type="date" class="g-due" value="{{due}}"></div>
        <div class="col-3"><label>Status</label>
          <select class="g-status">
            <option {{ongo}}>ongoing</option>
            <option {{done}}>done</option>
          </select>
        </div>
        <div class="col-6">
          <label>SMART checklist</label>
          <div class="stack">
            <label class="pill"><input class="g-smart g-s" type="checkbox" {{S}}> Specific</label>
            <label class="pill"><input class="g-smart g-m" type="checkbox" {{M}}> Measurable</label>
            <label class="pill"><input class="g-smart g-a" type="checkbox" {{A}}> Attainable</label>
            <label class="pill"><input class="g-smart g-r" type="checkbox" {{R}}> Relevant</label>
            <label class="pill"><input class="g-smart g-t" type="checkbox" {{T}}> Time-bound</label>
          </div>
        </div>
      </div>
      <div class="stack no-print" style="margin-top:8px">
        <button class="btn secondary btnDelGoal">Delete Goal</button>
      </div>
    </div>
  </script>

  <script id="tpl-intervention" type="text/x-template">
    <div class="card" data-id="{{id}}">
      <div class="row">
        <div class="col-8"><label>Intervention</label><input class="i-text" value="{{text}}" placeholder="Describe steps clearly"></div>
        <div class="col-4"><label>Linked Goal</label><select class="i-goal">{{goalOptions}}</select></div>
      </div>
      <div class="row">
        <div class="col-6"><label>Who</label><input class="i-who" value="{{who}}"></div>
        <div class="col-3"><label>Start</label><input type="date" class="i-start" value="{{start}}"></div>
        <div class="col-3"><label>Due</label><input type="date" class="i-due" value="{{due}}"></div>
      </div>
      <div class="stack no-print" style="margin-top:8px">
        <button class="btn secondary btnDelIntervention">Delete Intervention</button>
      </div>
    </div>
  </script>

  <script id="tpl-resource" type="text/x-template">
    <div class="card" data-id="{{id}}">
      <div class="row">
        <div class="col-8"><label>Resource</label><input class="r-text" value="{{text}}" placeholder="Skill/service/support"></div>
        <div class="col-4"><label>Person/Discipline</label><input class="r-who" value="{{who}}"></div>
      </div>
      <div class="stack no-print" style="margin-top:8px">
        <button class="btn secondary btnDelResource">Delete Resource</button>
      </div>
    </div>
  </script>

  <script id="tpl-review" type="text/x-template">
    <div class="card" data-id="{{id}}">
      <div class="row">
        <div class="col-3"><label>Date</label><input class="rv-date" type="date" value="{{date}}"></div>
        <div class="col-9"><label>Attendees (disciplines)</label><input class="rv-att" value="{{attendees}}" placeholder="e.g., Nurse; OT; SW; Psych; Family/Advocate"></div>
      </div>
      <label>Service-user voice since last review</label>
<textarea class="rv-voice">{{voice}}</textarea>

<label>Notes / Decisions (incl. ICP edits)</label>
<textarea class="rv-notes">{{notes}}</textarea>

<div class="row">
  <div class="col-8">
    <label>Team attendees</label>
    <div class="stack rv-team">
      <label class="pill"><input type="checkbox" class="rv-att-nurse"> Nurse</label>
      <label class="pill"><input type="checkbox" class="rv-att-ot"> OT</label>
      <label class="pill"><input type="checkbox" class="rv-att-sw"> Social Worker</label>
      <label class="pill"><input type="checkbox" class="rv-att-psych"> Psychiatrist</label>
      <label class="pill"><input type="checkbox" class="rv-att-psychol"> Psychology</label>
      <label class="pill"><input type="checkbox" class="rv-att-cmhn"> CMHN</label>
      <label class="pill"><input type="checkbox" class="rv-att-gp"> GP</label>
    </div>
  </div>
  <div class="col-4">
    <label>Additional attendees</label>
    <input class="rv-att-extra" value="{{att_extra}}" placeholder="Family/Advocate/Other">
  </div>
</div>

<label>Changes (achieved/new goals; obs/leave/risk; discharge)</label>
<textarea class="rv-changes">{{changes}}</textarea>
      <div class="row">
        <div class="col-4"><label>Next review date</label><input class="rv-next" type="date" value="{{next}}"></div>
        <div class="col-4"><label>MDT care planning session?</label><select class="rv-mdt"><option {{mdt_no}}>No</option><option {{mdt_yes}}>Yes</option></select></div>
      </div>
      <div class="stack no-print" style="margin-top:8px">
        <button class="btn secondary btnDelReview">Delete Review</button>
      </div>
    </div>
  </script>

  <script id="tpl-med" type="text/x-template">
    <div class="card" data-id="{{id}}">
      <div class="row">
        <div class="col-8">
          <label>Medicine</label>
          <div>
            <span class="tag">{{generic_name}}</span>
            {{#trade_name}}<span class="tag">{{trade_name}}</span>{{/trade_name}}
            <span class="tag">{{strength}}</span>
            <span class="tag">{{dose_form}}</span>
            <span class="tag">{{route}}</span>
            {{#atc_code}}<span class="tag">ATC: {{atc_code}}</span>{{/atc_code}}
          </div>
        </div>
        <div class="col-4">
          <label>Status</label>
          <select class="m-status">
            <option {{active}}>active</option>
            <option {{stopped}}>stopped</option>
            <option {{changed}}>changed</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="col-4"><label>Start</label><input type="date" class="m-start" value="{{startDate}}"></div>
        <div class="col-4"><label>End</label><input type="date" class="m-end" value="{{endDate}}"></div>
        <div class="col-4">
          <label>Prescribed as</label>
          <select class="m-brand">
            <option value="generic" {{as_generic}}>generic</option>
            <option value="brand" {{as_brand}}>brand</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="col-3"><label>Dose</label><input class="m-dose" value="{{dose}}"></div>
        <div class="col-3"><label>Unit</label><select class="m-unit"><option {{u_mg}}>mg</option><option {{u_mcg}}>mcg</option><option {{u_ml}}>mL</option><option {{u_tab}}>tablet(s)</option><option {{u_cap}}>capsule(s)</option></select></div>
        <div class="col-3"><label>Frequency</label><select class="m-freq"><option {{f_od}}>OD</option><option {{f_bd}}>BD</option><option {{f_td}}>TDS</option><option {{f_qid}}>QDS</option><option {{f_mane}}>mane</option><option {{f_nocte}}>nocte</option><option {{f_prn}}>PRN</option></select></div>
        <div class="col-3"><label>PRN?</label><select class="m-prn"><option {{prn_no}}>No</option><option {{prn_yes}}>Yes</option></select></div>
      </div>
      <div class="row">
        <div class="col-4"><label>Max per 24h</label><input class="m-max24" value="{{max24}}" placeholder="e.g., 6 mg"></div>
        <div class="col-8"><label>Directions (free text)</label><input class="m-schedule" value="{{schedule}}" placeholder="e.g., increase after 1 week to 100 mg mane"></div>
      </div>

      <label>Notes / cautions</label>
      <textarea class="m-notes">{{notes}}</textarea>

      <div class="stack no-print" style="margin-top:8px">
        <button class="btn secondary btnStop">Stop</button>
        <button class="btn secondary btnChange">Change</button>
        <button class="btn secondary btnDelete">Delete</button>
      </div>
    </div>
  </script>

  <!-- Embedded default policy JSON (editable) -->
  <script id="policy" type="application/json">
  {
    "inpatient": {
      "review_frequency_days": 7,
      "admission_prompts": [
        {"id":"risk","label":"Risk assessment completed"},
        {"id":"obs_level","label":"Observation/Leave level set"},
        {"id":"med_rec","label":"Medication reconciliation"},
        {"id":"physical","label":"Physical health assessment"},
        {"id":"family","label":"Family/Carer contact (if consented)"},
        {"id":"dc_begin","label":"Discharge planning initiated"}
      ],
      "discharge_pack": {"gp_summary": true, "composite_pdf": true, "ics_followup": true}
    },
    "outpatient": {
      "review_frequency_days": 365,
      "initial_prompts": [
        {"id":"gp_link","label":"GP details & discharge-to-GP plan"},
        {"id":"physical","label":"Physical health review / SMI care bundle"},
        {"id":"consent","label":"Consent/Capacity recorded"},
        {"id":"care_coord","label":"Care coordinator assigned"}
      ],
      "allow_individual_updates": true,
      "annual_mdt_required": true
    }
  }
  </script>
  
<script id="medsDataset" type="application/json">
[
  {
    "hpra_product_id": "SAMPLE001",
    "generic_name": "sertraline",
    "trade_name": "Lustral",
    "strength": "50 mg",
    "dose_form": "tablet",
    "route": "oral",
    "atc_code": "N06AB06",
    "reimbursable": true,
    "interchangeable_group_id": ""
  },
  {
    "hpra_product_id": "SAMPLE002",
    "generic_name": "quetiapine",
    "trade_name": "",
    "strength": "25 mg",
    "dose_form": "tablet",
    "route": "oral",
    "atc_code": "N05AH04",
    "reimbursable": true,
    "interchangeable_group_id": ""
  }
]
</script>

  <!-- ===== APP LOGIC ===== -->
  <script>
  // ----- Core state -----
  const cp = {
    state: {
      workflow: 'inpatient',           // 'inpatient' | 'outpatient'
      episodeState: 'InpatientActive', // state machine
      passphraseSet: false,
      data: {
        patient:{}, admission:{}, icp:{goals:[],interventions:[],resources:[]},
        risk:{}, reviews:[], discharge:{},
        meds: [],
        prompts:{},  // checked prompts
        audit:[]
      }
    },
    lastSavedHash: null
  };
  
  // Risk V4 schema (searchable: RISK_V4_SCHEMA)
const RISK_V4_SCHEMA = {
  static: [
    {id:'garda_adm', label:'Previous requirement for Garda assisted admission'},
    {id:'high_secure', label:'Previous admission to high secure setting'},
    {id:'abscond_hist', label:'Previous absconding from an inpatient setting'},
    {id:'violence_hist', label:'History of physical violence/threatening behaviour'},
    {id:'serious_attempt', label:'Serious suicide attempt'},
    {id:'weapons_hist', label:'Use of or carrying weapons'},
    {id:'selfharm_hist', label:'Past history of non-lethal self-harm'},
    {id:'forensic_hist', label:'Previous convictions/forensic history'},
    {id:'fam_suicide', label:'Family history of suicide'},
    {id:'male_u35', label:'Male < 35 yrs'},
    {id:'male', label:'Male'},
    {id:'persecutory_cmd', label:'Persecutory delusion/command hallucinations'},
    {id:'major_phys', label:'Major physical illness'},
    {id:'prop_damage', label:'Damage to property'},
    {id:'mmi_pd', label:'Major mental illness/Personality disorder'},
    {id:'child_adversity', label:'History of childhood adversity/trauma'},
    {id:'substance_hist', label:'History of alcohol/substance misuse'}
  ],
  dynamic: [
    {id:'si_plan', label:'Suicidal ideation with intent/current plan', weight:'high'},
    {id:'hopeless', label:'Expression of hopelessness', weight:'high'},
    {id:'active_symp', label:'Active symptoms (e.g., depressed mood, psychosis)', weight:'med'},
    {id:'selfharm_curr', label:'Current non-lethal self-harming', weight:'med'},
    {id:'disconnected', label:'Disconnected from family/friends/society', weight:'med'},
    {id:'passive_death', label:'Passive death wish', weight:'med'},
    {id:'si_no_plan', label:'Suicidal ideation – no plan', weight:'med'},
    {id:'burden', label:'Perceived burden on others', weight:'low'},
    {id:'substance_now', label:'Substance abuse/intoxication/withdrawal', weight:'high'},
    {id:'loss_change', label:'Loss event or change in circumstances', weight:'med'},
    {id:'psychosocial', label:'Other active psychosocial stressors', weight:'low'},
    {id:'abscond_attempt', label:'Absconding attempt (this admission)', weight:'high'}
  ],
  clinical: [
    {id:'poor_insight', label:'Poor insight'},
    {id:'delirium', label:'Confusion/delirium'},
    {id:'poor_intake', label:'Not eating/drinking'},
    {id:'acute_phys', label:'Physical illness'},
    {id:'falls_risk', label:'Clinical judgement on risk of falls'},
    {id:'polypharm', label:'Prescribed multiple medications'},
    {id:'poor_adherence', label:'Poor adherence to treatment'},
    {id:'pressure_ulcer', label:'Clinical judgement on risk of pressure ulcers'},
    {id:'infection', label:'High risk of transmitting/contracting infection'}
  ],
  protective: [
    {id:'no_protective', label:'Unable to identify protective factors'},
    {id:'family_support', label:'Family/friend support'},
    {id:'dependents', label:'Dependent children'},
    {id:'financial', label:'Financially secure'},
    {id:'housing', label:'Secure accommodation'},
    {id:'concordance', label:'Concordance with treatment plan'}
  ],
  opts: ['No','Yes','Unknown','N/A']
};

// Extend state (search: riskV4)
cp.state.data.riskV4 = cp.state.data.riskV4 || {
  static:{}, dynamic:{}, clinical:{}, protective:{},
  summary:'', mitigation:'',
  sign:{ med:'', medDate:'', nurse:'', nurseDate:'' },
  history: [] // prior signed entries
};

  // ----- Utilities -----
  const $ = sel => document.querySelector(sel);
  const $$ = sel => [...document.querySelectorAll(sel)];
  const uid = p => p + Math.random().toString(36).slice(2,8);
  const nowISO = () => new Date().toISOString();
  const shallowHash = obj => JSON.stringify(obj).length;
const esc = s => (s||'').toString().replace(/[&<>"']/g, m => ({
  '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;'
}[m]));
  const nl = s => (s||'').replace(/\n/g,'<br>');
  function strToNode(html){ const t=document.createElement('template'); t.innerHTML=html.trim(); return t.content.firstElementChild; }

  // ----- Crypto (AES-GCM + PBKDF2) -----
  async function deriveKey(pass, salt, iter=250000){
    const enc = new TextEncoder();
    const base = await crypto.subtle.importKey('raw', enc.encode(pass), 'PBKDF2', false, ['deriveKey']);
    return crypto.subtle.deriveKey(
      {name:'PBKDF2', salt, iterations:iter, hash:'SHA-256'},
      base, {name:'AES-GCM', length:256}, false, ['encrypt','decrypt']
    );
  }
  function b64(u8){return btoa(String.fromCharCode(...u8))}
  function b64d(s){return Uint8Array.from(atob(s), c=>c.charCodeAt(0))}
  async function encryptJSON(pass, obj){
    const enc = new TextEncoder();
    const salt = crypto.getRandomValues(new Uint8Array(16));
    const iv   = crypto.getRandomValues(new Uint8Array(12));
    const key  = await deriveKey(pass, salt);
    const data = enc.encode(JSON.stringify(obj));
    const ct   = new Uint8Array(await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, data));
    return {v:1, iter:250000, salt:b64(salt), iv:b64(iv), ct:b64(ct)};
  }
  async function decryptJSON(pass, pack){
    const dec = new TextDecoder();
    const salt = b64d(pack.salt), iv = b64d(pack.iv), ct = b64d(pack.ct);
    const key  = await deriveKey(pass, salt, pack.iter);
    const pt   = await crypto.subtle.decrypt({name:'AES-GCM', iv}, key, ct);
    return JSON.parse(dec.decode(new Uint8Array(pt)));
  }

  // ----- Audit chain -----
  async function sha256(u8){ return new Uint8Array(await crypto.subtle.digest('SHA-256', u8)); }
  async function audit(event, detail){
    const enc = new TextEncoder();
    const auditArr = cp.state.data.audit;
    const prev = auditArr[auditArr.length-1]?.chain || new Uint8Array(32);
    const payload = enc.encode(JSON.stringify({ts:new Date().toISOString(),event,detail}));
    const concat = new Uint8Array(prev.length + payload.length);
    concat.set(prev,0); concat.set(payload,prev.length);
    const link = await sha256(concat);
    auditArr.push({ts:new Date().toISOString(), event, detail, chain: Array.from(link)});
    renderAudit();
  }

  // ----- Tabs -----
  

</script>  
<script>
// One function to activate a panel and keep header buttons in sync
function activatePanel(panel){
  // panels
  document.querySelectorAll('.panel').forEach(x=>x.classList.remove('active'));
  document.getElementById(panel)?.classList.add('active');

  // header nav active state
  document.querySelectorAll('.nav-row .tab').forEach(btn=>{
    btn.classList.toggle('active', btn.getAttribute('data-panel') === panel);
  });
}

// Header nav clicks -> activate panel
document.querySelector('.nav-row')?.addEventListener('click', (e)=>{
  const b = e.target.closest('.tab'); if(!b) return;
  const panel = b.getAttribute('data-panel'); if(!panel) return;
  e.preventDefault();
  activatePanel(panel);
});

// Default panel on load
document.addEventListener('DOMContentLoaded', ()=> activatePanel('admission'));
</script>
<script>
// --- Header nav ↔ main tabs sync ---
// Clicks in the header nav should activate the same panel as the main tabs.
document.querySelector('.nav-row')?.addEventListener('click', (e) => {
  const b = e.target.closest('.tab'); if (!b) return;
  const panel = b.getAttribute('data-panel'); if (!panel) return;

  // Activate main tabs/panels
  const mainBtn = document.querySelector(`#tabs .tab[data-panel="${panel}"]`);
  if (mainBtn) mainBtn.click(); // re-use your existing #tabs handler

  // Reflect active state in the header nav
  document.querySelectorAll('.nav-row .tab').forEach(t => t.classList.remove('active'));
  b.classList.add('active');
});

// When main tabs change, reflect it in the header nav as well.
document.getElementById('tabs')?.addEventListener('click', (e) => {
  const t = e.target.closest('.tab'); if (!t) return;
  const panel = t.getAttribute('data-panel');
  if (!panel) return;
  document.querySelectorAll('.nav-row .tab').forEach(btn => {
    btn.classList.toggle('active', btn.getAttribute('data-panel') === panel);
  });
});
</script>

<script>
  // ----- Bind helpers -----
  function bindInput(id, path){
    const el = $('#'+id);
    const setFromState = ()=>{ const v = get(path); if(el.type==='checkbox') el.checked=!!v; else el.value=v||''; };
    setFromState(); el.addEventListener('input', ()=>{ set(path, el.type==='checkbox' ? el.checked : el.value ); markDirty(); });
  }
  function get(path){ return path.split('.').reduce((a,k)=>a&&a[k], cp.state.data); }
  function set(path, val){
    const ks = path.split('.'); let ref = cp.state.data;
    ks.slice(0,-1).forEach(k=>ref=ref[k]||(isFinite(+k)?[]:{})); ref[ks.at(-1)] = val;
  }
  function markDirty(){
    // Nudge user if print/save is stale
	document.getElementById('unsavedBanner')?.classList.remove('hidden');
    document.body.classList.add('dirty');
    $('#statusDirty').textContent = 'Unsaved';
    $('#unsavedBanner').classList.remove('hidden');
  }

  // ----- Admission binds -----
  ['patient.name','patient.dob','patient.ppsn','patient.eircode','patient.mrn','admission.date','admission.keyworker','admission.consult','admission.needs','admission.goals','admission.interventions','admission.coprod','admission.coprod_reason','admission.dc_discussed','admission.dc_notes','admission.child_edu','discharge.plan','discharge.follow','discharge.date','patient.gp_name','patient.gp_healthmail']
    .forEach((p,i)=>{
      const id = ['p_name','p_dob','p_ppsn','p_eircode','p_mrn','ep_start','adm_keyworker','adm_consult','adm_needs','adm_goals','adm_interventions','adm_coprod','adm_coprod_reason','adm_dc_discussed','adm_dc_notes','child_edu','dc_plan','dc_follow','dc_date','gp_name','gp_healthmail'][i];
      bindInput(id, p);
    });
    document.getElementById('p_dob')?.addEventListener('change', e=>{
  const v = e.target.value; if(!v) return;
  const d = new Date(v), now = new Date();
  let age = now.getFullYear() - d.getFullYear();
  const m = now.getMonth() - d.getMonth();
  if (m < 0 || (m === 0 && now.getDate() < d.getDate())) age--;
  set('patient.age', age);
  document.getElementById('p_age').value = age;
  markDirty();
});
  bindInput('p_age','patient.age');
  $('#is_child').addEventListener('change', e=>{
    const isChild = e.target.value==='Yes';
    $('.child-only').classList.toggle('hidden', !isChild);
    set('admission.is_child', isChild); markDirty();
  });

  // ----- Goals / Interventions / Resources renderers -----
  function renderGoals(){
    const wrap = $('#goals'); wrap.innerHTML='';
    const t = $('#tpl-goal').textContent;
    const items = cp.state.data.icp.goals;
    for(const g of items){
      const html = t
        .replaceAll('{{id}}', g.id)
        .replaceAll('{{text}}', esc(g.text||''))
        .replaceAll('{{owner}}', esc(g.owner||''))
        .replaceAll('{{due}}', esc(g.due||''))
        .replaceAll('{{ongo}}', g.status==='ongoing'?'selected':'' )
        .replaceAll('{{done}}', g.status==='done'?'selected':'' )
        .replaceAll('{{S}}', g.S?'checked':'')
        .replaceAll('{{M}}', g.M?'checked':'')
        .replaceAll('{{A}}', g.A?'checked':'')
        .replaceAll('{{R}}', g.R?'checked':'')
        .replaceAll('{{T}}', g.T?'checked':'');
      const node = strToNode(html); wrap.append(node);
      node.querySelector('.g-text').addEventListener('input', e=>{ g.text=e.target.value; markDirty(); });
      node.querySelector('.g-owner').addEventListener('input', e=>{ g.owner=e.target.value; markDirty(); });
      node.querySelector('.g-due').addEventListener('input', e=>{ g.due=e.target.value; markDirty(); });
      node.querySelector('.g-status').addEventListener('change', e=>{ g.status=e.target.value; markDirty(); });
      node.querySelectorAll('.g-smart').forEach(cb=>cb.addEventListener('change', e=>{
        const cls = [...cb.classList].find(c=>c.startsWith('g-'));
        const map={ 'g-s':'S','g-m':'M','g-a':'A','g-r':'R','g-t':'T' }; g[ map[cls] ]=cb.checked; markDirty();
      }));
      node.querySelector('.btnDelGoal').addEventListener('click',()=>{ cp.state.data.icp.goals = items.filter(x=>x.id!==g.id); renderGoals(); renderInterventions(); markDirty(); });
    }
  }
  function renderInterventions(){
    const wrap=$('#interventions'); wrap.innerHTML='';
    const t=$('#tpl-intervention').textContent;
    const options = cp.state.data.icp.goals.map(g=>`<option value="${g.id}">${esc(g.text||g.id)}</option>`).join('');
    for(const i of cp.state.data.icp.interventions){
      const html = t.replaceAll('{{id}}', i.id)
        .replaceAll('{{text}}', esc(i.text||''))
        .replaceAll('{{who}}', esc(i.who||''))
        .replaceAll('{{start}}', esc(i.start||''))
        .replaceAll('{{due}}', esc(i.due||''))
        .replaceAll('{{goalOptions}}', options);
      const node = strToNode(html); wrap.append(node);
      const sel = node.querySelector('.i-goal'); sel.value = i.goalId||'';
      node.querySelector('.i-text').addEventListener('input', e=>{ i.text=e.target.value; markDirty(); });
      node.querySelector('.i-who').addEventListener('input', e=>{ i.who=e.target.value; markDirty(); });
      node.querySelector('.i-start').addEventListener('input', e=>{ i.start=e.target.value; markDirty(); });
      node.querySelector('.i-due').addEventListener('input', e=>{ i.due=e.target.value; markDirty(); });
      sel.addEventListener('change', e=>{ i.goalId=e.target.value; markDirty(); });
      node.querySelector('.btnDelIntervention').addEventListener('click',()=>{ cp.state.data.icp.interventions = cp.state.data.icp.interventions.filter(x=>x.id!==i.id); renderInterventions(); markDirty(); });
    }
  }
  function renderResources(){
    const wrap=$('#resources'); wrap.innerHTML='';
    const t=$('#tpl-resource').textContent;
    for(const r of cp.state.data.icp.resources){
      const html = t.replaceAll('{{id}}', r.id).replaceAll('{{text}}', esc(r.text||'')).replaceAll('{{who}}', esc(r.who||''));
      const node = strToNode(html); wrap.append(node);
      node.querySelector('.r-text').addEventListener('input', e=>{ r.text=e.target.value; markDirty(); });
      node.querySelector('.r-who').addEventListener('input', e=>{ r.who=e.target.value; markDirty(); });
      node.querySelector('.btnDelResource').addEventListener('click',()=>{ cp.state.data.icp.resources = cp.state.data.icp.resources.filter(x=>x.id!==r.id); renderResources(); markDirty(); });
    }
  }
  function renderReviews(){

    const wrap=$('#reviews'); wrap.innerHTML='';
    const t=$('#tpl-review').textContent;
    for(const rv of cp.state.data.reviews){
      const html=t.replaceAll('{{id}}',rv.id)
        .replaceAll('{{date}}',esc(rv.date||''))
        .replaceAll('{{attendees}}',esc(rv.attendees||''))
        .replaceAll('{{notes}}',esc(rv.notes||''))
        .replaceAll('{{nursing}}',esc(rv.nursing||''))
        .replaceAll('{{psych}}',esc(rv.psychiatry||''))
        .replaceAll('{{ot}}',esc(rv.ot||''))
        .replaceAll('{{sw}}',esc(rv.sw||''))
        .replaceAll('{{psychol}}',esc(rv.psychology||''))
        .replaceAll('{{changes}}',esc(rv.changes||''))
        .replaceAll('{{mdt_yes}}', rv.mdt?'selected':'')
        .replaceAll('{{mdt_no}}', !rv.mdt?'selected':'')
        .replaceAll('{{next}}',esc(rv.next||''));
      const node=strToNode(html); wrap.append(node);
      // voice & extra attendees
node.querySelector('.rv-voice').addEventListener('input', e=>{ rv.voice = e.target.value; markDirty(); });
node.querySelector('.rv-att-extra').addEventListener('input', e=>{ rv.att_extra = e.target.value; markDirty(); });

// team tickboxes
const ticks = [
  ['.rv-att-nurse','att_nurse'],
  ['.rv-att-ot','att_ot'],
  ['.rv-att-sw','att_sw'],
  ['.rv-att-psych','att_psych'],
  ['.rv-att-psychol','att_psychol'],
  ['.rv-att-cmhn','att_cmhn'],
  ['.rv-att-gp','att_gp'],
];
ticks.forEach(([sel,key])=>{
  const cb = node.querySelector(sel); if(!cb) return;
  cb.checked = !!rv[key];
  cb.addEventListener('change', ()=>{ rv[key] = cb.checked; markDirty(); });
});
      node.querySelector('.rv-date').addEventListener('input',e=>{ rv.date=e.target.value; markDirty(); });
      node.querySelector('.rv-att').addEventListener('input',e=>{ rv.attendees=e.target.value; markDirty(); });
      node.querySelector('.rv-notes').addEventListener('input',e=>{ rv.notes=e.target.value; markDirty(); });
      node.querySelector('.rv-nursing').addEventListener('input',e=>{ rv.nursing=e.target.value; markDirty(); });
      node.querySelector('.rv-psych').addEventListener('input',e=>{ rv.psychiatry=e.target.value; markDirty(); });
      node.querySelector('.rv-ot').addEventListener('input',e=>{ rv.ot=e.target.value; markDirty(); });
      node.querySelector('.rv-sw').addEventListener('input',e=>{ rv.sw=e.target.value; markDirty(); });
      node.querySelector('.rv-psychol').addEventListener('input',e=>{ rv.psychology=e.target.value; markDirty(); });
      node.querySelector('.rv-changes').addEventListener('input',e=>{ rv.changes=e.target.value; markDirty(); });
      node.querySelector('.rv-next').addEventListener('input',e=>{ rv.next=e.target.value; markDirty(); });
      node.querySelector('.rv-mdt').addEventListener('change',e=>{ rv.mdt = (e.target.value==='Yes'); markDirty(); });
      node.querySelector('.btnDelReview').addEventListener('click',()=>{ cp.state.data.reviews = cp.state.data.reviews.filter(x=>x.id!==rv.id); renderReviews(); markDirty(); });
    }
  }
  function renderFollowups(){
  const wrap = document.getElementById('followList'); if(!wrap) return;
  wrap.innerHTML = '';
  const items = cp.state.data.discharge.followups;
  for(const f of items){
    const div = document.createElement('div'); div.className='card';
    div.innerHTML = `
      <div class="row">
        <div class="col-3"><label>Type</label>
          <select class="fu-type">
            <option ${f.type==='Outpatients'?'selected':''}>Outpatients</option>
            <option ${f.type==='CMHN'?'selected':''}>CMHN</option>
            <option ${f.type==='Day Hospital'?'selected':''}>Day Hospital</option>
            <option ${f.type==='Other'?'selected':''}>Other</option>
          </select>
        </div>
        <div class="col-3"><label>Date</label><input type="date" class="fu-date" value="${esc(f.date||'')}"></div>
        <div class="col-3"><label>Time</label><input type="time" class="fu-time" value="${esc(f.time||'')}"></div>
        <div class="col-3"><label>Where</label><input class="fu-where" value="${esc(f.where||'')}"></div>
      </div>
      <label>Notes</label><input class="fu-notes" value="${esc(f.notes||'')}">
      <div class="stack no-print" style="margin-top:8px">
        <button class="btn secondary fu-ics">Download .ics</button>
        <button class="btn secondary fu-del">Delete</button>
      </div>
    `;
    wrap.append(div);
    div.querySelector('.fu-type').addEventListener('change', e=>{ f.type=e.target.value; markDirty(); });
    div.querySelector('.fu-date').addEventListener('input', e=>{ f.date=e.target.value; markDirty(); });
    div.querySelector('.fu-time').addEventListener('input', e=>{ f.time=e.target.value; markDirty(); });
    div.querySelector('.fu-where').addEventListener('input', e=>{ f.where=e.target.value; markDirty(); });
    div.querySelector('.fu-notes').addEventListener('input', e=>{ f.notes=e.target.value; markDirty(); });
    div.querySelector('.fu-del').addEventListener('click', ()=>{ 
      cp.state.data.discharge.followups = items.filter(x=>x.id!==f.id); renderFollowups(); markDirty();
    });
    div.querySelector('.fu-ics').addEventListener('click', ()=>{
      const d = cp.state.data;
      const dt = (f.date||'') + (f.time? 'T'+f.time.replace(':','')+'00' : '');
      const uid = (Date.now()+'@careplanner.local');
      const name = (d.patient.name||'patient').replace(/\s+/g,'_');
      const ics = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//CarePlanner//Follow-up//EN
BEGIN:VEVENT
UID:${uid}
DTSTAMP:${new Date().toISOString().replace(/[-:]/g,'').split('.')[0]}Z
${f.time ? 'DTSTART:'+f.date.replace(/-/g,'')+'T'+f.time.replace(':','')+'00Z' : 'DTSTART;VALUE=DATE:'+f.date?.replace(/-/g,'')}
SUMMARY:${f.type} — ${(d.patient.name||'patient').toString().replace(/\n/g,' ')}
LOCATION:${(f.where||'').toString().replace(/\n/g,' ')}
DESCRIPTION:${(f.notes||'').toString().replace(/\n/g,' ')}
END:VEVENT
END:VCALENDAR`;
      const blob = new Blob([ics], {type:'text/calendar'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
      a.download = `FU_${name}_${f.type||'Followup'}.ics`; a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1500);
    });
  }
}
document.getElementById('btnAddFollow')?.addEventListener('click', ()=>{
  cp.state.data.discharge.followups.push({id:uid('fu_'), type:'Outpatients', date:'', time:'', where:'', notes:''});
  renderFollowups(); markDirty();
});
  function renderAudit(){
    const wrap=$('#auditLog'); if(!wrap) return; wrap.innerHTML='';
    for(const a of cp.state.data.audit.slice().reverse()){
      const tip = a.chain ? a.chain.slice(0,8).map(b=>b.toString(16).padStart(2,'0')).join('') : '';
      const div=document.createElement('div'); div.className='pill'; div.textContent=`${a.ts} — ${a.event}${a.detail?': '+a.detail:''}${tip?' — '+tip:''}`; wrap.append(div);
    }
  }

  // Buttons for lists
  $('#btnAddGoal').addEventListener('click',()=>{ cp.state.data.icp.goals.push({id:uid('g_'), text:'',owner:'',status:'ongoing',S:false,M:false,A:false,R:false,T:false}); renderGoals(); markDirty(); });
  $('#btnAddIntervention').addEventListener('click',()=>{ cp.state.data.icp.interventions.push({id:uid('i_'), text:'', who:'', goalId:'', start:'', due:''}); renderInterventions(); markDirty(); });
  $('#btnAddResource').addEventListener('click',()=>{ cp.state.data.icp.resources.push({id:uid('r_'), text:'', who:''}); renderResources(); markDirty(); });
  $('#btnAddReview').addEventListener('click',()=>{ cp.state.data.reviews.push({id:uid('rv_'), date:new Date().toISOString().slice(0,10), attendees:'', notes:'', changes:'', next:''}); renderReviews(); markDirty(); });

  // ----- Obs/Leave → Risk prompt -----
  
  $('#obsLeave').addEventListener('change', e=>{
    $('#riskPrompt').classList.remove('hidden');
    set('risk.pendingLevel', e.target.value);
    const critical = ['Special 1:1 nursing','30 minute nursing observations'];
if (critical.includes(e.target.value)) {
  alert('High observation level selected — ensure full risk assessment is updated and MDT informed.');
}
  });
  $('#btnCancelRisk').addEventListener('click',()=>{
    $('#riskPrompt').classList.add('hidden');
    $('#riskReason').value='';
    $('#obsLeave').value = get('risk.level') || 'Special 1:1 nursing';
  });
  $('#btnConfirmRisk').addEventListener('click', async ()=>{
  if(!requireRole(['Clinician','Psychiatrist'], 'risk_change')) return;

  const lvl = get('risk.pendingLevel') || $('#obsLeave').value;
  const reason = $('#riskReason').value.trim();
  if(!reason){ alert('Please add a short rationale.'); return; }

  set('risk.level', lvl);
  set('risk.reason', reason);
  set('risk.summary', $('#risk_summary').value);

  $('#riskPrompt').classList.add('hidden');
  $('#riskReason').value='';

  await audit('risk_change', `Obs/Leave → ${lvl}. Reason: ${reason}. By: ${auth.user.name} (${auth.user.role})`);
  markDirty();
});
  function renderRiskV4Group(containerId, group, store){
  const wrap = document.getElementById(containerId); if(!wrap) return; 
  wrap.innerHTML = '';
  group.forEach(item=>{
    const sel = document.createElement('select');
    sel.innerHTML = RISK_V4_SCHEMA.opts.map(o=>`<option ${ (store[item.id]||'')===o?'selected':'' }>${o}</option>`).join('');
    sel.addEventListener('change', e=>{ store[item.id]=e.target.value; markDirty(); riskV4CheckFlags(); });
    const lab = document.createElement('label'); lab.textContent = item.label;
    const row = document.createElement('div'); row.className='row';
    const c1 = document.createElement('div'); c1.className='col-8'; c1.append(lab);
    const c2 = document.createElement('div'); c2.className='col-4'; c2.append(sel);
    row.append(c1,c2); wrap.append(row);
  });
}

function riskV4CheckFlags(){
  const dyn = cp.state.data.riskV4.dynamic || {};
  const isHigh = RISK_V4_SCHEMA.dynamic.some(d => (d.weight==='high') && (dyn[d.id]==='Yes'));
  document.getElementById('riskV4Flags').classList.toggle('hidden', !isHigh);
  // If high → force mitigation & signatures before printing
  cp.state.data.riskV4._high = !!isHigh;
}

function renderRiskV4(){
  const d = cp.state.data.riskV4;
  renderRiskV4Group('riskV4Static', RISK_V4_SCHEMA.static, d.static);
  renderRiskV4Group('riskV4Dynamic', RISK_V4_SCHEMA.dynamic, d.dynamic);
  renderRiskV4Group('riskV4Clinical', RISK_V4_SCHEMA.clinical, d.clinical);
  renderRiskV4Group('riskV4Protective', RISK_V4_SCHEMA.protective, d.protective);
  document.getElementById('riskV4Summary').value = d.summary || '';
  document.getElementById('riskV4Mitigation').value = d.mitigation || '';
  document.getElementById('riskV4SignMed').value = d.sign.med || '';
  document.getElementById('riskV4SignNurse').value = d.sign.nurse || '';
  document.getElementById('riskV4DateMed').value = d.sign.medDate || '';
  document.getElementById('riskV4DateNurse').value = d.sign.nurseDate || '';
  riskV4CheckFlags();
}

// Bind SU/Carer involvement (search anchor: SERVICE_USER_INV_BIND)
['suPresent','suPresentWhy','suAgrees','suDisagreeNote','suCopyOffered','suCopyWhy','carerInvolved','carerNotes']
.forEach(id=>{
  const el = document.getElementById(id);
  if (!el) return;
  el.addEventListener('input', e=>{
    cp.state.data.icp = cp.state.data.icp || {};
    cp.state.data.icp.su = cp.state.data.icp.su || {};
    cp.state.data.icp.su[id] = e.target.value;
    markDirty();
    document.getElementById('unsavedBanner')?.classList.remove('hidden');
  });
});

// Wire binds
document.getElementById('riskV4Summary')?.addEventListener('input', e=>{ cp.state.data.riskV4.summary = e.target.value; markDirty(); });
document.getElementById('riskV4Mitigation')?.addEventListener('input', e=>{ cp.state.data.riskV4.mitigation = e.target.value; markDirty(); });
['riskV4SignMed','riskV4SignNurse','riskV4DateMed','riskV4DateNurse'].forEach(id=>{
  document.getElementById(id)?.addEventListener('input', e=>{
    const s = cp.state.data.riskV4.sign;
    if(id==='riskV4SignMed') s.med = e.target.value;
    if(id==='riskV4SignNurse') s.nurse = e.target.value;
    if(id==='riskV4DateMed') s.medDate = e.target.value;
    if(id==='riskV4DateNurse') s.nurseDate = e.target.value;
    markDirty();
  });
});

document.getElementById('riskV4Save')?.addEventListener('click', async ()=>{
  // Guard rails if high risk
  const rv4 = cp.state.data.riskV4;
  if(rv4._high){
    if(!(rv4.mitigation||'').trim()){ alert('Mitigation measures required for high-risk.'); return; }
    if(!(rv4.sign.med && rv4.sign.medDate && rv4.sign.nurse && rv4.sign.nurseDate)){
      alert('Dual sign-off (NCHD/Consultant + RPN) required.'); return;
    }
  }
  // Snapshot history
  const snapshot = JSON.parse(JSON.stringify(rv4));
  snapshot.ts = new Date().toISOString();
  (cp.state.data.riskV4.history ||= []).push(snapshot);
  await audit('risk_v4_update', `high=${!!rv4._high}; obs=${get('risk.level')||''}`);
  markDirty(); alert('Risk assessment saved.');
});

// Call inside init/renderAll
(function(){ try { renderRiskV4(); } catch(e) { console.warn('riskV4 render skipped:', e); }})();
  bindInput('risk_summary','risk.summary');

  // ----- Medications dataset, search & render -----
  let MEDS = [];
  
  async function cp_loadMedsDataset(url='ireland_meds_sample.json'){
  // 1) If running over http/https, try normal fetch first (same-origin on GitHub Pages etc.)
  if (location.protocol === 'http:' || location.protocol === 'https:') {
    try {
      const res = await fetch(url, { cache: 'no-cache' });
      if (res.ok) { MEDS = await res.json(); return; }
    } catch(e) {
      console.warn('HTTP fetch failed, will try fallbacks:', e);
    }
  }

  // 2) Fallback: embedded dataset in the page (script[type=application/json]#medsDataset)
  try {
    const txt = document.getElementById('medsDataset')?.textContent?.trim();
    if (txt) { MEDS = JSON.parse(txt); return; }
  } catch(e) {
    console.warn('Embedded medsDataset parse failed:', e);
  }

  // 3) Last resort when opened as file:// — prompt user to pick a JSON file
  try {
    const f = await pickMedsFile();
    if (f) { MEDS = JSON.parse(await f.text()); return; }
  } catch(e) {
    console.warn('Manual meds file load failed:', e);
  }

  MEDS = [];
  alert('Could not load the medicines dataset. If you are opening this file from your disk (file://), click “Load Meds Dataset…” and select a JSON file.');
}
function pickMedsFile(){
  return new Promise(resolve=>{
    const inp = document.createElement('input');
    inp.type = 'file';
    inp.accept = '.json,application/json';
    inp.onchange = () => resolve(inp.files?.[0] || null);
    inp.click();
  });
}
  function cp_searchMeds(q){
    q = (q||'').trim().toLowerCase();
    if(!q) return [];
    return MEDS.filter(m =>
      (m.generic_name||'').toLowerCase().includes(q) ||
      (m.trade_name||'').toLowerCase().includes(q) ||
      (m.strength||'').toLowerCase().includes(q) ||
      (m.dose_form||'').toLowerCase().includes(q)
    ).slice(0, 30);
  }
  function cp_addMedFromRef(ref){
    const id = uid('m_');
    const entry = {
      id,
      hpra_product_id: ref.hpra_product_id || '',
      generic_name: ref.generic_name || '',
      trade_name: ref.trade_name || '',
      strength: ref.strength || '',
      dose_form: ref.dose_form || '',
      route: ref.route || '',
      atc_code: ref.atc_code || '',
      reimbursable: !!ref.reimbursable,
      interchangeable_group_id: ref.interchangeable_group_id || '',
      status:'active',
      startDate: new Date().toISOString().slice(0,10),
      endDate:'',
      prescribedBrand:false,
      dose:'', unit:'mg', freq:'OD', prn:false, max24:'', schedule:'',
      notes: ref.notes || ''
    };
    cp.state.data.meds.push(entry);
    audit('med_add', `${entry.generic_name} ${entry.strength} ${entry.dose_form} (${entry.route})`);
    cp_renderMeds();
    markDirty();
  }
  function tplRenderMed(tpl, m){
    return tpl
      .replaceAll('{{id}}', m.id)
      .replaceAll('{{generic_name}}', esc(m.generic_name))
      .replaceAll('{{trade_name}}', esc(m.trade_name||''))
      .replace('{{#trade_name}}', m.trade_name ? '' : '<!--').replace('{{/trade_name}}', m.trade_name ? '' : '-->')
      .replaceAll('{{strength}}', esc(m.strength||''))
      .replaceAll('{{dose_form}}', esc(m.dose_form||''))
      .replaceAll('{{route}}', esc(m.route||''))
      .replaceAll('{{atc_code}}', esc(m.atc_code||''))
      .replace('{{#atc_code}}','').replace('{{/atc_code}}','')
      .replaceAll('{{startDate}}', esc(m.startDate||''))
      .replaceAll('{{endDate}}', esc(m.endDate||''))
      .replaceAll('{{dose}}', esc(m.dose||''))
      .replaceAll('{{u_mg}}', m.unit==='mg'?'selected':'')
      .replaceAll('{{u_mcg}}', m.unit==='mcg'?'selected':'')
      .replaceAll('{{u_ml}}', m.unit==='mL'?'selected':'')
      .replaceAll('{{u_tab}}', m.unit==='tablet(s)'?'selected':'')
      .replaceAll('{{u_cap}}', m.unit==='capsule(s)'?'selected':'')
      .replaceAll('{{f_od}}', m.freq==='OD'?'selected':'')
      .replaceAll('{{f_bd}}', m.freq==='BD'?'selected':'')
      .replaceAll('{{f_td}}', m.freq==='TDS'?'selected':'')
      .replaceAll('{{f_qid}}', m.freq==='QDS'?'selected':'')
      .replaceAll('{{f_mane}}', m.freq==='mane'?'selected':'')
      .replaceAll('{{f_nocte}}', m.freq==='nocte'?'selected':'')
      .replaceAll('{{f_prn}}', m.freq==='PRN'?'selected':'')
      .replaceAll('{{prn_yes}}', m.prn?'selected':'')
      .replaceAll('{{prn_no}}', !m.prn?'selected':'')
      .replaceAll('{{max24}}', esc(m.max24||''))
      .replaceAll('{{schedule}}', esc(m.schedule||''))
      .replaceAll('{{notes}}', esc(m.notes||''))
      .replaceAll('{{active}}', m.status==='active'?'selected':'')
      .replaceAll('{{stopped}}', m.status==='stopped'?'selected':'')
      .replaceAll('{{changed}}', m.status==='changed'?'selected':'')
      .replaceAll('{{as_generic}}', !m.prescribedBrand ? 'selected' : '')
      .replaceAll('{{as_brand}}', m.prescribedBrand ? 'selected' : '');
  }
  function cp_renderMeds(){
    const list = $('#medList'); if(!list) return; list.innerHTML = '';
    const tpl = $('#tpl-med').textContent;
    for(const m of cp.state.data.meds){
      const html = tplRenderMed(tpl, m);
      const node = strToNode(html);
      list.append(node);

      // binds
      node.querySelector('.m-status').addEventListener('change', e=>{
        m.status = e.target.value;
        if(m.status==='stopped' && !m.endDate){ m.endDate = new Date().toISOString().slice(0,10); }
        audit('med_status', `${m.generic_name} → ${m.status}`); markDirty(); cp_renderGpSummary();
      });
      node.querySelector('.m-start').addEventListener('input', e=>{ m.startDate = e.target.value; markDirty(); });
      node.querySelector('.m-end').addEventListener('input', e=>{ m.endDate = e.target.value; markDirty(); });
      node.querySelector('.m-brand').addEventListener('change', e=>{
        m.prescribedBrand = (e.target.value==='brand'); markDirty();
      });
      node.querySelector('.m-dose').addEventListener('input', e=>{ m.dose = e.target.value; markDirty(); cp_renderGpSummary(); });
      node.querySelector('.m-unit').addEventListener('change', e=>{ m.unit = e.target.value; markDirty(); cp_renderGpSummary(); });
      node.querySelector('.m-freq').addEventListener('change', e=>{ m.freq = e.target.value; markDirty(); cp_renderGpSummary(); });
      node.querySelector('.m-prn').addEventListener('change', e=>{ m.prn = (e.target.value==='Yes'); markDirty(); cp_renderGpSummary(); });
      node.querySelector('.m-max24').addEventListener('input', e=>{ m.max24 = e.target.value; markDirty(); cp_renderGpSummary(); });
      node.querySelector('.m-schedule').addEventListener('input', e=>{ m.schedule = e.target.value; markDirty(); cp_renderGpSummary(); });
      node.querySelector('.m-notes').addEventListener('input', e=>{ m.notes = e.target.value; markDirty(); });

      node.querySelector('.btnStop').addEventListener('click', ()=>{
        m.status='stopped'; m.endDate = new Date().toISOString().slice(0,10);
        audit('med_stop', `${m.generic_name}`); markDirty(); cp_renderMeds(); cp_renderGpSummary();
      });
      node.querySelector('.btnChange').addEventListener('click', ()=>{
        m.status='changed';
        audit('med_change', `${m.generic_name}`); markDirty(); cp_renderMeds(); cp_renderGpSummary();
      });
      node.querySelector('.btnDelete').addEventListener('click', ()=>{
        if(confirm('Delete this medication entry?')) {
          cp.state.data.meds = cp.state.data.meds.filter(x=>x.id!==m.id);
          audit('med_delete', `${m.generic_name}`); markDirty(); cp_renderMeds(); cp_renderGpSummary();
        }
      });
    }
    cp_renderGpSummary();
  }
  function cp_renderGpSummary(){
    const el = $('#medGpSummary'); if(!el) return;
    const active = cp.state.data.meds.filter(m=>m.status==='active');
    const stopped = cp.state.data.meds.filter(m=>m.status!=='active');
    const line = m => {
    const base = `${esc(m.generic_name)} ${esc(m.strength)} ${esc(m.dose_form)} (${esc(m.route)})`;
    const dose = m.dose? ` — ${esc(m.dose)} ${esc(m.unit||'')}` : '';
    const freq = m.freq? ` ${esc(m.freq)}` : '';
    const prn  = m.prn? ' (PRN)' : '';
    const max  = m.max24? ` [max/24h: ${esc(m.max24)}]` : '';
    const ft   = m.schedule? ` — ${esc(m.schedule)}` : '';
    const brand = (m.prescribedBrand && m.trade_name)? ` [brand: ${esc(m.trade_name)}]` : '';
    return base + dose + freq + prn + max + ft + brand;
  };
    el.innerHTML = `
      <p><strong>Active:</strong><br>${active.map(line).join('<br>') || '—'}</p>
      <p><strong>Stopped/Changed:</strong><br>${stopped.map(line).join('<br>') || '—'}</p>
    `;
  }
  $('#medSearch').addEventListener('input', e=>{
    const q = e.target.value;
    const results = cp_searchMeds(q);
    $('#medResults').innerHTML = results.map(r => `
      <div class="result" data-id="${r.hpra_product_id}">
        ${esc(r.generic_name)} ${esc(r.strength)} — ${esc(r.dose_form)} (${esc(r.route)})${r.trade_name? ' · '+esc(r.trade_name):''}
      </div>`).join('');
  });
  $('#medResults').addEventListener('click', e=>{
    const div = e.target.closest('.result'); if(!div) return;
    const ref = MEDS.find(m => m.hpra_product_id === div.dataset.id);
    if(ref){ cp_addMedFromRef(ref); $('#medResults').innerHTML=''; $('#medSearch').value=''; }
  });

  // ----- Policy handling -----
  let POLICY = {};
  function loadEmbeddedPolicy(){
    try { POLICY = JSON.parse($('#policy').textContent); }
    catch(e){ POLICY = {}; }
    $('#policyJson').value = JSON.stringify(POLICY, null, 2);
    renderPolicyPrompts();
    updateCadenceBadge();
  }
  function renderPolicyPrompts(){
    const el = $('#policyPrompts'); if(!el) return;
    const wf = cp.state.workflow;
    const cfg = POLICY[wf] || {};
    const prompts = (wf==='inpatient' ? cfg.admission_prompts : cfg.initial_prompts) || [];
    // Build checklist UI
    el.innerHTML = prompts.map(p=>{
      const checked = !!cp.state.data.prompts[p.id];
      return `<label class="pill"><input type="checkbox" data-prompt="${p.id}" ${checked?'checked':''}> ${esc(p.label)}</label>`;
    }).join(' ');
    el.addEventListener('change', e=>{
      if(e.target.matches('[data-prompt]')){
        const id = e.target.getAttribute('data-prompt');
        cp.state.data.prompts[id] = e.target.checked;
        audit('prompt', `${id} → ${e.target.checked?'done':'undone'}`); markDirty();
      }
    }, {once:true});
  }
  $('#btnPolicyApply').addEventListener('click', ()=>{
    try {
      const obj = JSON.parse($('#policyJson').value);
      POLICY = obj; renderPolicyPrompts(); updateCadenceBadge();
      alert('Policy applied.');
    } catch(e){ alert('Invalid JSON'); }
  });

  // ----- Workflow & state controls -----
  $('#workflowSel').addEventListener('change', e=>{
    cp.state.workflow = e.target.value;
    $('#workflowLabel').textContent = cp.state.workflow==='inpatient' ? 'Inpatient' : 'Outpatient';
    renderPolicyPrompts(); updateCadenceBadge(); markDirty();
  });
  $('#stateSel').addEventListener('change', e=>{
    cp.state.episodeState = e.target.value; markDirty();
  });
  $('#btnHandover').addEventListener('click', ()=>{
    // switch to outpatient; keep goals/resources, reset obs/leave
    cp.state.workflow = 'outpatient';
    $('#workflowSel').value = 'outpatient';
    $('#workflowLabel').textContent = 'Outpatient';
    set('risk.level',''); set('risk.reason','');
    audit('handover', 'Inpatient→Outpatient');
    renderPolicyPrompts(); updateCadenceBadge(); buildComposite(); markDirty();
  });
  $('#btnNewEpisode').addEventListener('click', ()=>{
    // Minimal: clear admission/discharge/reviews/risk; keep patient & meds & goals
    cp.state.data.admission = {};
    cp.state.data.discharge = {};
    cp.state.data.reviews = [];
    cp.state.data.risk = {};
    audit('episode_new','New episode started');
    renderAll(); buildComposite(); markDirty();
  });

  // ----- Review cadence -----
  function getReviewFrequencyDays(){
    const wf = cp.state.workflow;
    return (POLICY[wf]?.review_frequency_days) || (wf==='inpatient'?7:365);
  }
  function updateCadenceBadge(){
    const days = getReviewFrequencyDays();
    $('#reviewDue').textContent = `Review cadence: every ${days} day(s)`;
  }
  function checkReviewDue(){
    const r = cp.state.data.reviews.slice(-1)[0];
    const days = getReviewFrequencyDays();
    if(!r){ $('#reviewDue').textContent = 'No review recorded yet — please add one.'; return; }
    const last = new Date(r.date); const d = (Date.now()-last)/86400000;
    $('#reviewDue').textContent = `Last review ${Math.floor(d)} day(s) ago (policy: ${days}d)`;
    if(d>days) alert('Review due — please add a review entry and Save & Print ICP.');
  }
  setInterval(checkReviewDue, 6*3600*1000); // every 6 hours

  // ----- Save / Export / Import with encryption -----
  let PASSPHRASE = '';
  function setSecState(text){ $('#secState').textContent = text; }
  $('#btnSetPass').addEventListener('click', async ()=>{
    const p = $('#passInput').value.trim();
    if(!p){ alert('Enter a passphrase first.'); return; }
    PASSPHRASE = p; cp.state.passphraseSet = true; setSecState('Passphrase set');
    await audit('security','passphrase_set');
    alert('Passphrase set!');
  });
  $('#btnUnlock').addEventListener('click', async ()=>{
    const p = $('#passInput').value.trim(); if(!p){ alert('Enter a passphrase.'); return; }
    const raw = localStorage.getItem('careplanner_v2_enc');
    if(!raw){ alert('No encrypted data found.'); return; }
    try{
      const data = await decryptJSON(p, JSON.parse(raw));
      cp.state.data = data; PASSPHRASE = p; cp.state.passphraseSet = true; setSecState('Unlocked');
      renderAll(); buildComposite(); renderAudit(); await audit('security','unlocked');
      alert('Data unlocked successfully!');
    }catch(e){ alert('Incorrect passphrase or corrupt data.'); }
  });
  $('#btnPrint').addEventListener('click', async ()=>{
    const require = $('#requirePass').checked;
    if(require && !cp.state.passphraseSet){ alert('Set a passphrase first (Security bar).'); return; }
    await saveEncrypted(); buildComposite();
    // Block print if high-risk without mitigation/signatures
const rv4 = cp.state.data.riskV4 || {};
if(rv4._high){
  const ok = (rv4.mitigation||'').trim() && rv4.sign?.med && rv4.sign?.medDate && rv4.sign?.nurse && rv4.sign?.nurseDate;
  if(!ok){ alert('High-risk present: mitigation + dual sign-off required before printing.'); return; }
}
     window.print();
  });
  $('#btnExport').addEventListener('click', async ()=>{
    const blob = new Blob([JSON.stringify(cp.state.data,null,2)],{type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
    a.download=`careplan_${(cp.state.data.patient.name||'patient').replace(/\\s+/g,'_')}.json`; a.click();
  });
  $('#importBtn').addEventListener('click',()=>$('#fileImport').click());
  $('#fileImport').addEventListener('change', async (e)=>{
    const f=e.target.files[0]; if(!f) return;
    const text=await f.text(); try{
      cp.state.data = JSON.parse(text); await saveEncrypted(); renderAll(); buildComposite(); audit('import','Loaded JSON file');
    }catch(err){ alert('Invalid JSON'); }
  });
  $('#btnClearLocal').addEventListener('click',async ()=>{
    if(confirm('Clear all locally stored data? This cannot be undone.')){
      localStorage.removeItem('careplanner_v2_enc'); PASSPHRASE=''; cp.state.passphraseSet=false; setSecState('Unlocked (demo)');
      cp.state.data={patient:{}, admission:{}, icp:{goals:[],interventions:[],resources:[]},risk:{},reviews:[],discharge:{},meds:[],prompts:{},audit:[]};
      renderAll(); buildComposite(); await audit('admin','cleared_local');
    }
  });

  async function saveEncrypted(){
    const pack = await encryptJSON(PASSPHRASE || 'demo', cp.state.data);
    localStorage.setItem('careplanner_v2_enc', JSON.stringify(pack));
    cp.lastSavedHash = shallowHash(cp.state.data);
    document.body.classList.remove('dirty');
    $('#statusDirty').textContent = 'Saved';
    $('#unsavedBanner').classList.add('hidden');
    await audit('save','encrypted_local');
  }

  setInterval(()=>{
    if(!cp.lastSavedHash) return;
    const dirty = shallowHash(cp.state.data)!==cp.lastSavedHash;
    $('#unsavedBanner').classList.toggle('hidden', !dirty);
    $('#statusDirty').textContent = dirty ? 'Unsaved' : 'Saved';
  }, 1200);

  // ----- GP Pack preview -----
  $('#btnBuildGpPack').addEventListener('click', ()=>{
    const d = cp.state.data;
    const meds = d.meds.filter(m=>m.status==='active').map(m=>`${esc(m.generic_name)} ${esc(m.strength)} ${esc(m.dose_form)} — ${esc(m.schedule||'')}`).join('<br>') || '—';
    const html = `
      <h3>GP Update Summary</h3>
      <p><strong>Patient:</strong> ${esc(d.patient.name||'')} (MRN: ${esc(d.patient.mrn||'')})</p>
      <p><strong>Diagnosis/Presenting:</strong> ${esc(d.admission.needs||'')}</p>
      <p><strong>Medications:</strong><br>${meds}</p>
      <p><strong>Risks/Alerts:</strong><br>${nl(esc(d.risk.summary||''))}</p>
      <p><strong>Care Plan (top goals):</strong><br>${d.icp.goals.slice(0,3).map(g=>esc(g.text||'')).join('<br>') || '—'}</p>
      const fu = (d.discharge.followups||[]).map(f=>`${esc(f.type)} — ${esc(f.date||'')}${f.time?' '+esc(f.time):''}`).join('<br>') || '—';
      + `<p><strong>Follow-ups:</strong><br>${fu}</p>`
      <p><strong>Team contact:</strong> ${esc(d.admission.keyworker||'')} | ${esc(d.admission.consult||'')}</p>
    `;
    const box = $('#gpPackPreview'); box.innerHTML = html; box.classList.remove('hidden');
  });

  // ----- Composite Print Builder -----
  function buildComposite(){
    const d = cp.state.data;
    const el = $('#printArea'); if(!el) return; el.innerHTML='<div id="printArea" class="print-section"></div>';
    const s = (h)=>{ const div=document.createElement('div'); div.className='print-section'; div.innerHTML=h; el.append(div); };
    const chainTip = d.audit.length ? d.audit[d.audit.length-1].chain.slice(0,8).map(b=>b.toString(16).padStart(2,'0')).join('') : '';

    // Header
    s(`<h3>Header</h3>
       <p><strong>Workflow:</strong> \${esc(cp.state.workflow)} &nbsp; <strong>State:</strong> \${esc(cp.state.episodeState)}</p>
       <p><strong>Name:</strong> \${esc(d.patient.name||'')} &nbsp; <strong>DOB:</strong> \${esc(d.patient.dob||'')} &nbsp; <strong>Age:</strong> \${esc(d.patient.age||'')}</p>
       <p><strong>PPSN:</strong> \${esc(d.patient.ppsn||'')} &nbsp; <strong>Eircode:</strong> \${esc(d.patient.eircode||'')} &nbsp; <strong>MRN:</strong> \${esc(d.patient.mrn||'')}</p>
       <p><strong>GP:</strong> \${esc(d.patient.gp_name||'')} &nbsp; <strong>Healthmail:</strong> \${esc(d.patient.gp_healthmail||'')}</p>`);

    // Admission & Interim / Initial
    s(`<h3>Admission / Initial ICP</h3>
       <p><strong>Start:</strong> \${esc(d.admission.date||'')} &nbsp; <strong>Key worker:</strong> \${esc(d.admission.keyworker||'')} &nbsp; <strong>Consultant:</strong> \${esc(d.admission.consult||'')}</p>
       <p><strong>Co-produced:</strong> \${esc(d.admission.coprod||'')} \${d.admission.coprod==='no'?' — '+esc(d.admission.coprod_reason||''):''}</p>
       \${d.admission.is_child?'<p><strong>Child:</strong> Yes — <strong>Education:</strong> '+esc(d.admission.child_edu||'')+'</p>':''}
       <p><strong>Service-user voice / needs:</strong><br>\${nl(esc(d.admission.needs||''))}</p>
       <p><strong>Initial goals:</strong><br>\${nl(esc(d.admission.goals||''))}</p>
       <p><strong>Initial interventions/resources:</strong><br>\${nl(esc(d.admission.interventions||''))}</p>`);
		const su = (cp.state.data.icp||{}).su || {};
s(`
  <h3>Service-user & Carer Involvement</h3>
  <table border="1" cellspacing="0" cellpadding="6" width="100%">
    <tr><th>Field</th><th>Value</th></tr>
    <tr><td>SU present at ICP?</td><td>${esc(su.suPresent||'—')}</td></tr>
    <tr><td>If No/NA, explain</td><td>${esc(su.suPresentWhy||'')}</td></tr>
    <tr><td>SU agrees with ICP?</td><td>${esc(su.suAgrees||'—')}</td></tr>
    <tr><td>If No/Not sure, view</td><td>${esc(su.suDisagreeNote||'')}</td></tr>
    <tr><td>Copy of ICP offered?</td><td>${esc(su.suCopyOffered||'—')}</td></tr>
    <tr><td>If No/Deferred, explain</td><td>${esc(su.suCopyWhy||'')}</td></tr>
    <tr><td>Carer/family involved?</td><td>${esc(su.carerInvolved||'—')}</td></tr>
    <tr><td>Carer notes</td><td>${esc(su.carerNotes||'')}</td></tr>
  </table>
`);
    // Policy prompts
    const wf = cp.state.workflow;
    const cfg = POLICY[wf] || {};
    const prompts = (wf==='inpatient' ? cfg.admission_prompts : cfg.initial_prompts) || [];
    const promptRows = prompts.map(p=>`<tr><td>\${esc(p.label)}</td><td>\${getPromptState(p.id) ? '✓' : '—'}</td></tr>`).join('');
    s(`<h3>Policy Checklist (\${wf})</h3>
       <table border="1" cellspacing="0" cellpadding="6" width="100%"><tr><th>Item</th><th>Done</th></tr>\${promptRows}</table>`);

    // Full ICP
    const goalRows = d.icp.goals.map(g=>`<tr><td>\${esc(g.text||'')}</td><td>\${esc(g.owner||'')}</td><td>\${esc(g.status||'')}</td><td>\${esc(g.due||'')}</td></tr>`).join('');
    const intRows  = d.icp.interventions.map(i=>`<tr><td>\${esc((d.icp.goals.find(g=>g.id===i.goalId)||{}).text||'')}</td><td>\${esc(i.text||'')}</td><td>\${esc(i.who||'')}</td><td>\${esc(i.start||'')} → \${esc(i.due||'')}</td></tr>`).join('');
    const resRows  = d.icp.resources.map(r=>`<tr><td>\${esc(r.text||'')}</td><td>\${esc(r.who||'')}</td></tr>`).join('');
// ---------- PRINT: Care Plan Actions (with Need column) ----------
const actions = cp.state.data.actions || [];
if (actions.length){
  s(`<h3>Care Plan Actions</h3>
     <table border="1" cellspacing="0" cellpadding="6" width="100%">
       <tr>
         <th>#</th><th>Need</th><th>Goal</th><th>Action</th><th>Responsible</th><th>Status</th>
       </tr>
       ${actions.map((it, i)=>`
         <tr>
           <td>${i+1}</td>
           <td>${esc(it.need||'')}</td>
           <td>${esc(it.goal||'')}</td>
           <td>${esc(it.action||'')}</td>
           <td>${esc(it.responsible||'')}</td>
           <td>${esc(it.status||'')}</td>
         </tr>`).join('')}
     </table>`);
}

    s(`<h3>Full MDT ICP</h3>
      <h4>Goals</h4><table border="1" cellspacing="0" cellpadding="6" width="100%"><tr><th>Goal</th><th>Owner</th><th>Status</th><th>Due</th></tr>\${goalRows}</table>
      <h4>Interventions</h4><table border="1" cellspacing="0" cellpadding="6" width="100%"><tr><th>Linked Goal</th><th>Intervention</th><th>Who</th><th>Dates</th></tr>\${intRows}</table>
      <h4>Resources</h4><table border="1" cellspacing="0" cellpadding="6" width="100%"><tr><th>Resource</th><th>Person/Discipline</th></tr>\${resRows}</table>`);
const su = (cp.state.data.icp||{}).su || {};
s(`
  <h3>Service-user & Carer Involvement</h3>
  <table border="1" cellspacing="0" cellpadding="6" width="100%">
    <tr><th>Field</th><th>Value</th></tr>
    <tr><td>SU present at ICP?</td><td>${esc(su.suPresent||'—')}</td></tr>
    <tr><td>If No/NA, explain</td><td>${esc(su.suPresentWhy||'')}</td></tr>
    <tr><td>SU agrees with ICP?</td><td>${esc(su.suAgrees||'—')}</td></tr>
    <tr><td>If No/Not sure, view</td><td>${esc(su.suDisagreeNote||'')}</td></tr>
    <tr><td>Copy of ICP offered?</td><td>${esc(su.suCopyOffered||'—')}</td></tr>
    <tr><td>If No/Deferred, explain</td><td>${esc(su.suCopyWhy||'')}</td></tr>
    <tr><td>Carer/family involved?</td><td>${esc(su.carerInvolved||'—')}</td></tr>
    <tr><td>Carer notes</td><td>${esc(su.carerNotes||'')}</td></tr>
  </table>
`);
    // Risk / Obs & Leave
    // Risk / Observations & Leave + V4
const rv4 = cp.state.data.riskV4||{};
const tbl = (title, group, store) => `
  <h4>${title}</h4>
  <table border="1" cellspacing="0" cellpadding="6" width="100%">
    <tr><th>Item</th><th>Value</th></tr>
    ${group.map(x=>`<tr><td>${esc(x.label)}</td><td>${esc(store?.[x.id]||'—')}</td></tr>`).join('')}
  </table>`;
if (cp.state.flags?.riskV4NeedsUpdate) {
  s(`<div style="border:1px solid #b91c1c;background:#fef2f2;padding:8px;margin:8px 0">
        <strong>Reminder:</strong> Observation/Leave changed. Please complete an updated Risk Assessment (V4).
     </div>`);
}
s(`<h3>Risk / Observations & Leave</h3>
  <p><strong>Observation/Leave:</strong> ${esc(d.risk.level||'')}</p>
  <p><strong>Rationale:</strong><br>${nl(esc(d.risk.reason||''))}</p>
  ${tbl('Historical / Static', RISK_V4_SCHEMA.static, rv4.static)}
  ${tbl('Dynamic (current)', RISK_V4_SCHEMA.dynamic, rv4.dynamic)}
  ${tbl('Clinical Safety', RISK_V4_SCHEMA.clinical, rv4.clinical)}
  ${tbl('Protective Factors', RISK_V4_SCHEMA.protective, rv4.protective)}
  <p><strong>Summary of risk profile</strong><br>${nl(esc(rv4.summary||''))}</p>
  <p><strong>Risk mitigation measures</strong><br>${nl(esc(rv4.mitigation||''))}</p>
  <p><strong>Sign-off:</strong> NCHD/Consultant ${esc(rv4.sign?.med||'')} (MCN) — ${esc(rv4.sign?.medDate||'')}; 
     RPN ${esc(rv4.sign?.nurse||'')} — ${esc(rv4.sign?.nurseDate||'')}</p>
`);
const su = (cp.state.data.icp||{}).su || {};
s(`
  <h3>Service-user & Carer Involvement</h3>
  <table border="1" cellspacing="0" cellpadding="6" width="100%">
    <tr><th>Field</th><th>Value</th></tr>
    <tr><td>SU present at ICP?</td><td>${esc(su.suPresent||'—')}</td></tr>
    <tr><td>If No/NA, explain</td><td>${esc(su.suPresentWhy||'')}</td></tr>
    <tr><td>SU agrees with ICP?</td><td>${esc(su.suAgrees||'—')}</td></tr>
    <tr><td>If No/Not sure, view</td><td>${esc(su.suDisagreeNote||'')}</td></tr>
    <tr><td>Copy of ICP offered?</td><td>${esc(su.suCopyOffered||'—')}</td></tr>
    <tr><td>If No/Deferred, explain</td><td>${esc(su.suCopyWhy||'')}</td></tr>
    <tr><td>Carer/family involved?</td><td>${esc(su.carerInvolved||'—')}</td></tr>
    <tr><td>Carer notes</td><td>${esc(su.carerNotes||'')}</td></tr>
  </table>
`);
    // Meds
    const medLine = m => `\${esc(m.generic_name)} \${esc(m.strength)} \${esc(m.dose_form)} (\${esc(m.route)})`
      + (m.prescribedBrand && m.trade_name? ` [brand: \${esc(m.trade_name)}]`:'')
      + (m.schedule? ` — \${esc(m.schedule)}`:'')
      + (m.status!=='active'? ` — \${esc(m.status)}\${m.endDate? ' '+esc(m.endDate):''}`:'');
    const medsActive = d.meds?.filter(m=>m.status==='active') || [];
    const medsOther  = d.meds?.filter(m=>m.status!=='active') || [];
    s(`<h3>Medications</h3>
       <p><strong>Active:</strong><br>\${medsActive.map(medLine).join('<br>') || '—'}</p>
       <p><strong>Stopped/Changed:</strong><br>\${medsOther.map(medLine).join('<br>') || '—'}</p>`);

    // Reviews (show voice + structured attendees)
const attCols = r=>{
  const teams = ['nurse','ot','sw','psych','psychol','cmhn','gp']
    .filter(k=>r['att_'+k]).map(k=>k.toUpperCase()).join(', ');
  return `${esc(teams)}${r.att_extra ? (teams?'; ':'')+esc(r.att_extra) : ''}`;
};
const rvRows = d.reviews.map(r=>`<tr>
  <td>${esc(r.date||'')}</td>
  <td>${attCols(r)}</td>
  <td>${nl(esc(r.voice||''))}</td>
  <td>${nl(esc(r.notes||''))}</td>
  <td>${nl(esc(r.changes||''))}</td>
  <td>${esc(r.next||'')}</td>
</tr>`).join('');

s(`<h3>Reviews</h3>
<table border="1" cellspacing="0" cellpadding="6" width="100%">
  <tr>
    <th>Date</th>
    <th>Attendees</th>
    <th>Service-user voice</th>
    <th>Notes/Decisions</th>
    <th>Changes</th>
    <th>Next Review</th>
  </tr>
  ${rvRows}
</table>`);
const su = (cp.state.data.icp||{}).su || {};
s(`
  <h3>Service-user & Carer Involvement</h3>
  <table border="1" cellspacing="0" cellpadding="6" width="100%">
    <tr><th>Field</th><th>Value</th></tr>
    <tr><td>SU present at ICP?</td><td>${esc(su.suPresent||'—')}</td></tr>
    <tr><td>If No/NA, explain</td><td>${esc(su.suPresentWhy||'')}</td></tr>
    <tr><td>SU agrees with ICP?</td><td>${esc(su.suAgrees||'—')}</td></tr>
    <tr><td>If No/Not sure, view</td><td>${esc(su.suDisagreeNote||'')}</td></tr>
    <tr><td>Copy of ICP offered?</td><td>${esc(su.suCopyOffered||'—')}</td></tr>
    <tr><td>If No/Deferred, explain</td><td>${esc(su.suCopyWhy||'')}</td></tr>
    <tr><td>Carer/family involved?</td><td>${esc(su.carerInvolved||'—')}</td></tr>
    <tr><td>Carer notes</td><td>${esc(su.carerNotes||'')}</td></tr>
  </table>
`);
    // Discharge
    const fu = (d.discharge.followups||[]).map(f=>`${esc(f.type)} — ${esc(f.date||'')}${f.time?' '+esc(f.time):''}${f.where?' @ '+esc(f.where):''}${f.notes?': '+esc(f.notes):''}`).join('<br>') || '—';
     s(`<h3>Discharge Planning</h3>
     <p><strong>Planned discharge date:</strong> ${esc(d.discharge.date||'')}</p>
     <p><strong>Follow-ups:</strong><br>${fu}</p>
     <p><strong>Plan:</strong><br>${nl(esc(d.discharge.plan||''))}</p>`);
const su = (cp.state.data.icp||{}).su || {};
s(`
  <h3>Service-user & Carer Involvement</h3>
  <table border="1" cellspacing="0" cellpadding="6" width="100%">
    <tr><th>Field</th><th>Value</th></tr>
    <tr><td>SU present at ICP?</td><td>${esc(su.suPresent||'—')}</td></tr>
    <tr><td>If No/NA, explain</td><td>${esc(su.suPresentWhy||'')}</td></tr>
    <tr><td>SU agrees with ICP?</td><td>${esc(su.suAgrees||'—')}</td></tr>
    <tr><td>If No/Not sure, view</td><td>${esc(su.suDisagreeNote||'')}</td></tr>
    <tr><td>Copy of ICP offered?</td><td>${esc(su.suCopyOffered||'—')}</td></tr>
    <tr><td>If No/Deferred, explain</td><td>${esc(su.suCopyWhy||'')}</td></tr>
    <tr><td>Carer/family involved?</td><td>${esc(su.carerInvolved||'—')}</td></tr>
    <tr><td>Carer notes</td><td>${esc(su.carerNotes||'')}</td></tr>
  </table>
`);
    // Audit tail
    const auRows = d.audit.map(a=>`<tr><td>\${a.ts}</td><td>\${esc(a.event||'')}</td><td>\${esc(a.detail||'')}</td></tr>`).join('');
    s(`<h3>Audit</h3><p><strong>Audit chain tip:</strong> 0x\${chainTip}</p>
       <table border="1" cellspacing="0" cellpadding="6" width="100%">
        <tr><th>Timestamp</th><th>Event</th><th>Detail</th></tr>\${auRows}</table>`);
  }
  function getPromptState(id){ return !!cp.state.data.prompts[id]; }

  // ----- Init -----
  async function init(){
    // Load encrypted if present (demo unlock requires passphrase)
    const saved = localStorage.getItem('careplanner_v2_enc');
    if(!saved){
      cp.state.data = cp.state.data; // default
    }
    cp.lastSavedHash = shallowHash(cp.state.data);
    $('#workflowSel').value = cp.state.workflow;
    $('#workflowLabel').textContent = 'Inpatient';
    $('#stateSel').value = cp.state.episodeState;

    await cp_loadMedsDataset();
    loadEmbeddedPolicy();

    renderAll(); buildComposite(); renderAudit(); checkReviewDue();
  }
  function renderAll(){ renderGoals(); renderInterventions(); renderResources(); renderReviews(); cp_renderMeds(); toggleChild(); }
  function toggleChild(){ const on = !!cp.state.data.admission?.is_child; $('.child-only').classList.toggle('hidden', !on); }

  init();
  document.addEventListener('DOMContentLoaded', ()=>{
  if (location.protocol === 'file:') {
    const btn = document.createElement('button');
    btn.className = 'btn ghost';
    btn.id = 'btnLoadMedsLocal';
    btn.textContent = 'Load Meds Dataset…';
    btn.style.marginBottom = '6px';

    // Try to place above the meds search box, else add at top of the body
    const target = document.getElementById('medSearch')?.parentElement || document.body;
    target.prepend(btn);

    btn.addEventListener('click', async ()=>{
      try {
        const f = await pickMedsFile();
        if (!f) return;
        MEDS = JSON.parse(await f.text());
        alert(`Loaded ${MEDS.length} medicine entries.`);
        // repaint suggestions if user has typed
        const q = document.getElementById('medSearch')?.value || '';
        if (q) { 
          (window.renderMedResults || (()=>{}))(q);
        }
      } catch(e) {
        alert('Could not load that JSON file.');
      }
    });
  }
});
  </script>
<script>

// ---------- Actions state ----------
cp.state.data.actions ||= []; // each item: {need, goal, action, responsible, status}

// ---------- Actions rendering ----------
function renderActions(){
  const tb = document.getElementById('actionsTbody');
  if(!tb) return;
  tb.innerHTML = '';
  cp.state.data.actions.forEach((item, idx)=>{
    const tr = document.createElement('tr');

    // #
    const cIdx = document.createElement('td'); cIdx.textContent = (idx+1);
    tr.appendChild(cIdx);

    // Need
    const cNeed = document.createElement('td');
    const needSel = makeNeedsSelect(item.need||'');
    needSel.addEventListener('change', e=>{
      item.need = e.target.value; markDirty();
      document.getElementById('unsavedBanner')?.classList.remove('hidden');
    });
    cNeed.appendChild(needSel);
    tr.appendChild(cNeed);

    // Goal
    const cGoal = document.createElement('td');
    const inGoal = document.createElement('input'); inGoal.value = item.goal||'';
    inGoal.placeholder = 'Goal';
    inGoal.addEventListener('input', e=>{ item.goal=e.target.value; markDirty(); document.getElementById('unsavedBanner')?.classList.remove('hidden');});
    cGoal.appendChild(inGoal); tr.appendChild(cGoal);

    // Action
    const cAct = document.createElement('td');
    const inAct = document.createElement('input'); inAct.value = item.action||'';
    inAct.placeholder = 'Action';
    inAct.addEventListener('input', e=>{ item.action=e.target.value; markDirty(); document.getElementById('unsavedBanner')?.classList.remove('hidden');});
    cAct.appendChild(inAct); tr.appendChild(cAct);

    // Responsible
    const cResp = document.createElement('td');
    const inResp = document.createElement('input'); inResp.value = item.responsible||'';
    inResp.placeholder = 'Responsible person/team';
    inResp.addEventListener('input', e=>{ item.responsible=e.target.value; markDirty(); document.getElementById('unsavedBanner')?.classList.remove('hidden');});
    cResp.appendChild(inResp); tr.appendChild(cResp);

    // Status
    const cStatus = document.createElement('td');
    const stSel = document.createElement('select');
    ['Due','Ongoing','Completed','Deferred'].forEach(s=>{
      const o=document.createElement('option'); o.textContent=s;
      if((item.status||'')===s) o.selected=true; stSel.appendChild(o);
    });
    stSel.addEventListener('change', e=>{ item.status=e.target.value; markDirty(); document.getElementById('unsavedBanner')?.classList.remove('hidden');});
    cStatus.appendChild(stSel); tr.appendChild(cStatus);

    // Delete
    const cDel = document.createElement('td'); cDel.className='no-print';
    const btnDel = document.createElement('button'); btnDel.className='btn'; btnDel.textContent='Delete';
    btnDel.addEventListener('click', ()=>{
      cp.state.data.actions.splice(idx,1);
      markDirty(); renderActions();
    });
    cDel.appendChild(btnDel); tr.appendChild(cDel);

    tb.appendChild(tr);
  });
}

// Add button
document.getElementById('btnAddAction')?.addEventListener('click', ()=>{
  cp.state.data.actions.push({need:'1. Mental health', goal:'', action:'', responsible:'', status:'Due'});
  markDirty(); renderActions();
});

// Call once during init
try { renderActions(); } catch(e){ /* ignore on first load */ }

// ----- Auth / Roles (local demo) -----
const auth = {
  user: {
    name: document.getElementById('userNameInput')?.value || 'Local User',
    role: document.getElementById('userRoleSel')?.value || 'Clinician'
  }
};
// keep header badges in sync
function syncHeaderUser(){
  const n = document.getElementById('userName'); if(n) n.textContent = auth.user.name;
  const r = document.getElementById('userRole'); if(r) r.textContent = auth.user.role;
}
// wire the admin inputs → auth
document.getElementById('userNameInput')?.addEventListener('input', e=>{
  auth.user.name = e.target.value; syncHeaderUser();
});
document.getElementById('userRoleSel')?.addEventListener('change', e=>{
  auth.user.role = e.target.value; syncHeaderUser();
});
// initial paint
syncHeaderUser();


function esc(s){ return String(s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
// ICP needs and helpers
const ICP_NEEDS = [
  '1. Mental health','2. Physical health','3. Medication','4. Safety/Risk',
  '5. Substance use','6. Housing/Accommodation','7. Finance/Income',
  '8. ADLs/Self-care','9. Social/Family','10. Meaningful activity/Education/Work',
  '11. Legal/Advocacy','12. Transport/Access','13. Cultural/Spiritual',
  '14. Communication','15. Nutrition','16. Other'
];
function renderNeedsSelect(selected=''){
  const sel = document.createElement('select');
  sel.className = 'needsTag';
  ICP_NEEDS.forEach(opt=>{
    const o = document.createElement('option');
    o.textContent = opt; if (opt===selected) o.selected = true; sel.appendChild(o);
  });
  return sel;
}


// role helpers
function hasRole(...roles){ return roles.includes((auth.user||{}).role); }
function requireRole(roles, action){
  if(!Array.isArray(roles)) roles = [roles];
  if(!hasRole(...roles)){
    alert('This action requires one of: '+roles.join(', ')+'. Your role: '+auth.user.role);
    return false;
  }
  return true;
}




// ----- GP Pack downloads -----
function buildGpHtml(){
  const d = cp.state.data;
  const meds = d.meds.filter(m=>m.status==='active').map(m=>`${esc(m.generic_name)} ${esc(m.strength)} ${esc(m.dose_form)} — ${esc(m.schedule||'')}`).join('<br>') || '—';
    const summary = `<!doctype html><html><head><meta charset="utf-8"><title>GP Summary — ${esc(d.patient.name||'')}</title>
<style id="hse-brand-tokens">
  :root{
    /* Typography stays Arial (per HSE) */
    --hse-font: Arial, "Helvetica Neue", Helvetica, sans-serif;

    /* Text & base */
    --hse-text: #212B32;              /* $hse-text-color = $color_hse-grey-900 */
    --hse-text-secondary: #455C68;    /* $hse-secondary-text-color = $color_hse-grey-700 */
    --hse-bg-tint: #F3F3F3;           /* $color_hse-grey-50 (page background tint) */
    --hse-bg-white: #FFFFFF;          /* $color_hse-white-0 */
    --hse-border: #AEB7BD;            /* $hse-border-color = $color_hse-grey-300 */

    /* Links */
    --hse-link: #0B55B7;              /* $hse-link-color = $color_hse-blue */
    --hse-link-hover: #782CC3;        /* $hse-link-hover-color = $color_hse-purple-500 */
    --hse-link-visited: #5F3DC4;      /* $hse-link-visited-color = $color_hse-purple-700 */
    --hse-link-active: #0B55B780;     /* $hse-link-active-color (shade of link) */

    /* Focus */
    --hse-focus-bg: #73E6C2;          /* $hse-focus-color = $color_hse-green-300 */
    --hse-focus-text: #212B32;        /* $hse-focus-text-color = $color_hse-grey-900 */
    --hse-focus-width: 3px;

    /* Buttons (HSE primary = purple family) */
    --hse-btn-primary: #5F3DC4;       /* $hse-button-color = $color_hse-purple-700 */
    --hse-btn-primary-hover: #782CC3; /* $hse-button-hover-color = $color_hse-purple-500 */
    --hse-btn-primary-text: #FFFFFF;  /* $hse-button-text-color = $color_hse-white-0 */
    --hse-btn-disabled-bg: #D8DDE0;   /* $hse-button-disabled-color = $color_hse-grey-100 */
    --hse-btn-disabled-text: #768692; /* $hse-button-disabled-text-color = $color_hse-grey-500 */

    /* Secondary button (outlined purple) */
    --hse-btn-secondary-border: #5F3DC4;         /* $hse-secondary-button-border-color */
    --hse-btn-secondary-hover-border: #782CC3;   /* $hse-secondary-button-hover-color */
    --hse-btn-secondary-text: #5F3DC4;           /* $hse-secondary-button-text-color */
    --hse-btn-secondary-text-hover: #782CC3;     /* $hse-secondary-button-hover-text-color */

    /* Status colours (forms / alerts) */
    --hse-error: #B30638;             /* $hse-error-color = $color_hse-red-500 */
    --hse-warn:  #FFDE0E;             /* $color_hse-yellow-500 */

    /* Palette refs (if needed elsewhere) */
    --hse-green-900:#00473E; --hse-green-700:#02594C; --hse-green-500:#02A78B; --hse-green-300:#73E6C2; --hse-green-100:#80FFD8; --hse-green-50:#ECFBF6;
    --hse-grey-900:#212B32; --hse-grey-700:#455C68; --hse-grey-500:#768692; --hse-grey-300:#AEB7BD; --hse-grey-100:#D8DDE0; --hse-grey-50:#F3F3F3;
    --hse-blue-500:#0B55B7;
    --hse-purple-700:#5F3DC4; --hse-purple-500:#782CC3; --hse-purple-300:#AA37E0;
    --hse-red-500:#B30638;
    --hse-yellow-500:#FFDE0E;
  }
  html, body { font-family: var(--hse-font); color: var(--hse-text); background: var(--hse-bg-tint); }
</style>
</head>
<body>
<div id="brandingBar" class="no-print" style="display:none">
  <div id="brandingLeft"><img id="hseLogo" alt="HSE logo"/></div>
  <div id="brandingRight"><img id="partnerLogo" alt="Partner logo" style="display:none"/></div>
</div>
<h2>GP Update Summary</h2>
<p><strong>Patient:</strong> ${esc(d.patient.name||'')} (MRN: ${esc(d.patient.mrn||'')})</p>
<p><strong>GP:</strong> ${esc(d.patient.gp_name||'')} — ${esc(d.patient.gp_healthmail||'')}</p>
<p><strong>Diagnosis/Presenting:</strong> ${esc(d.admission.needs||'')}</p>
<p><strong>Medications:</strong><br>${meds}</p>
<p><strong>Risks/Alerts:</strong><br>${nl(esc(d.risk.summary||''))}</p>
<p><strong>Care Plan (top goals):</strong><br>${d.icp.goals.slice(0,3).map(g=>esc(g.text||'')).join('<br>') || '—'}</p>
<p><strong>Follow-up:</strong> ${esc(d.discharge.follow||'')} on ${esc(d.discharge.date||'')}</p>
<p><strong>Prepared by:</strong> ${esc(auth.user.name)} (${esc(auth.user.role)}) — ${new Date().toISOString()}</p>

</body>
</html>`;
  return summary;
}

</script>
<script>
// ===== Canonical JSON + SHA-256 document hash =====
function canonicalize(obj){
  if(obj===null || typeof obj!=='object') return obj;
  if(Array.isArray(obj)) return obj.map(canonicalize);
  const keys = Object.keys(obj).sort();
  const out = {};
  for(const k of keys){ out[k] = canonicalize(obj[k]); }
  return out;
}
async function computeDocHash(){
  const enc = new TextEncoder();
  const canon = JSON.stringify(canonicalize(cp.state.data));
  const buf = await crypto.subtle.digest('SHA-256', enc.encode(canon));
  const u8 = new Uint8Array(buf);
  return Array.from(u8).map(b=>b.toString(16).padStart(2,'0')).join('');
}
async function refreshDocHash(){
  try{
    const h = await computeDocHash();
    document.getElementById('docHash').textContent = h.slice(0,16) + '…';
    return h;
  } catch(e){ console.warn('Hash error', e); return ''; }
}
document.getElementById('btnCopyHash').addEventListener('click', async ()=>{
  const full = await computeDocHash();
  await navigator.clipboard.writeText(full);
  alert('Document hash copied to clipboard:\\n' + full);
});

// Hook buildComposite to include full hash in print (safe even if not yet defined)
(function attachHashHook(){
  function attach(){
    if (typeof buildComposite !== 'function') return false;
    const _buildComposite = buildComposite;         // alias existing
    buildComposite = async function(){              // wrap with hash appender
      await _buildComposite();
      const h = await computeDocHash();
      const el = document.getElementById('printArea');
      if (el){
        const note = document.createElement('p');
        note.innerHTML = `<strong>Document Hash (SHA-256):</strong> <code>${h}</code>`;
        el.appendChild(note);
      }
    };
    return true;
  }
  if (!attach()){
    document.addEventListener('DOMContentLoaded', attach);
  }
})();

// Recompute hash when saving and periodically on edits
const _markDirty = markDirty;
markDirty = function(){ _markDirty(); refreshDocHash(); };
const _saveEncrypted = saveEncrypted;
saveEncrypted = async function(){ await _saveEncrypted(); await refreshDocHash(); };

document.addEventListener('DOMContentLoaded', ()=>refreshDocHash());
</script>

<script>
function groupMeds(results){
  const map = new Map();
  for(const m of results){
    const key = [m.generic_name||'', m.strength||'', m.dose_form||'', m.route||''].map(s=>s.toLowerCase().trim()).join('|');
    if(!map.has(key)) map.set(key, { key, base: m, brands: new Set() });
    if(m.trade_name) map.get(key).brands.add(m.trade_name);
  }
  return [...map.values()].map(g=>({ 
    key: g.key, 
    base: g.base, 
    brands: [...g.brands].sort()
  }));
}
function renderMedResults(q){
  const results = cp_searchMeds(q);
  const groups = groupMeds(results);
  document.getElementById('medResults').innerHTML = groups.map(g=>{
    const b = g.brands.length ? ` · brands: ${g.brands.slice(0,6).join(', ')}` : '';
    return `<div class="result" data-key="${g.key}" data-id="${g.base.hpra_product_id}">
      ${esc(g.base.generic_name)} ${esc(g.base.strength)} — ${esc(g.base.dose_form)} (${esc(g.base.route)})${b}
    </div>`;
  }).join('');
}
document.getElementById('medSearch').removeEventListener?.('input', ()=>{}); // defensive
document.getElementById('medSearch').addEventListener('input', e=> renderMedResults(e.target.value));
document.getElementById('medResults').addEventListener('click', e=>{
  const div = e.target.closest('.result'); if(!div) return;
  const id = div.dataset.id; const ref = MEDS.find(m => m.hpra_product_id === id);
  if(!ref) return;
  cp_addMedFromRef(ref);
  document.getElementById('medResults').innerHTML=''; document.getElementById('medSearch').value='';
});
</script>

<script>
function lastMdtDate(){
  const mdts = (cp.state.data.reviews||[]).filter(r=>r.mdt && r.date);
  if(!mdts.length) return null;
  return new Date(mdts[mdts.length-1].date);
}
function updateMdtOverdueBanner(){
  const wrap = document.getElementById('mdtOverdue'); if(!wrap) return;
  wrap.classList.add('hidden');
  if(cp.state.workflow!=='outpatient') return;
  const last = lastMdtDate();
  if(!last){ wrap.classList.remove('hidden'); return; }
  const days = (Date.now()-last)/86400000;
  if(days>365) wrap.classList.remove('hidden');
}
document.getElementById('btnReviewIcsMdt')?.addEventListener('click', ()=>{
  const next = new Date(Date.now() + 14*86400000); // 2 weeks from now
  const y = next.toISOString().slice(0,10).replace(/-/g,'');
  const d = cp.state.data;
  const ics = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//CarePlanner//MDT Reminder//EN
BEGIN:VEVENT
UID:${Date.now()}@careplanner.local
DTSTAMP:${new Date().toISOString().replace(/[-:]/g,'').split('.')[0]}Z
DTSTART;VALUE=DATE:${y}
SUMMARY:Annual MDT Care Planning — ${(d.patient.name||'patient').toString().replace(/\n/g,' ')}
DESCRIPTION:At least one MDT care planning session per year is required.
END:VEVENT
END:VCALENDAR`;
  const name = (d.patient.name||'patient').replace(/\s+/g,'_');
  const blob = new Blob([ics], {type:'text/calendar'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `MDT_${name}.ics`; a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1500);
});
// Hook into renderReviews
const __renderReviews = renderReviews;
renderReviews = function(){ __renderReviews(); updateMdtOverdueBanner(); };
document.addEventListener('DOMContentLoaded', updateMdtOverdueBanner);
</script>

<script>
/*! Tiny QR (very small subset) — based on Kazuhiko Arase's qrcode-generator (MIT) trimmed */
(function(){
  function QR8bitByte(data){this.mode=4;this.data=data;this.parsed=unescape(encodeURIComponent(data));this.getLength=function(){return this.parsed.length};this.write=function(buf){for(var i=0;i<this.parsed.length;i++)buf.put(this.parsed.charCodeAt(i),8)}}
  function QRPolynomial(num, shift){if(num.length==undefined)throw new Error(num.length+"/"+shift);var offset=0;while(offset<num.length&&num[offset]==0)offset++;this.num=new Array(num.length-offset+shift);for(var i=0;i<num.length-offset;i++)this.num[i]=num[i+offset]}
  QRPolynomial.prototype={get:function(i){return this.num[i]},getLength:function(){return this.num.length},multiply:function(e){var num=new Array(this.getLength()+e.getLength()-1);for(var i=0;i<this.getLength();i++)for(var j=0;j<e.getLength();j++)num[i+j]^=QRMath.gexp(QRMath.glog(this.get(i))+QRMath.glog(e.get(j)));return new QRPolynomial(num,0)},mod:function(e){if(this.getLength()-e.getLength()<0)return this;var ratio=QRMath.glog(this.get(0))-QRMath.glog(e.get(0));var num=new Array(this.getLength());for(var i=0;i<this.getLength();i++)num[i]=this.get(i);for(i=0;i<e.getLength();i++)num[i]^=QRMath.gexp(QRMath.glog(e.get(i))+ratio);return new QRPolynomial(num,0).mod(e)}}
  var QRMath={glog:function(n){if(n<1)throw new Error("glog("+n+")");return QRMath.LOG_TABLE[n]},gexp:function(n){while(n<0)n+=255;while(n>=256)n-=255;return QRMath.EXP_TABLE[n]},EXP_TABLE:new Array(256),LOG_TABLE:new Array(256)};
  for(var i=0;i<8;i++)QRMath.EXP_TABLE[i]=1<<i;for(i=8;i<256;i++)QRMath.EXP_TABLE[i]=QRMath.EXP_TABLE[i-4]^QRMath.EXP_TABLE[i-5]^QRMath.EXP_TABLE[i-6]^QRMath.EXP_TABLE[i-8];
  for(i=0;i<256;i++)QRMath.LOG_TABLE[QRMath.EXP_TABLE[i]]=i;
  var QRMode={MODE_8BIT_BYTE:4}, QRErrorCorrectLevel={L:1};
  var QRMaskPattern={PATTERN000:0};
  function QRUtil(){}
  QRUtil.getBCHTypeInfo=function(data){var d=data<<10;while(QRUtil.getBCHDigit(d)-QRUtil.getBCHDigit(1335)>=0)d^=(1335<<(QRUtil.getBCHDigit(d)-QRUtil.getBCHDigit(1335)));return((data<<10)^d)};
  QRUtil.getBCHDigit=function(data){var d=0;while(data!=0){d++;data>>>=1}return d};
  QRUtil.getMask=function(mask,x,y){switch(mask){case QRMaskPattern.PATTERN000:return (x+y)%2==0;default:throw new Error("bad mask");}};
  QRUtil.getErrorCorrectPolynomial=function(ecLength){var a=new QRPolynomial([1],0);for(var i=0;i<ecLength;i++)a=a.multiply(new QRPolynomial([1,QRMath.gexp(i)],0));return a};
  function QRBitBuffer(){this.buffer=[];this.length=0}
  QRBitBuffer.prototype={get:function(i){return((this.buffer[Math.floor(i/8)]>>> (7 - i % 8)) & 1)==1},put:function(num,length){for(var i=0;i<length;i++)this.putBit(((num>>> (length - i -1)) & 1)==1)},putBit:function(bit){this.buffer.push(bit?1:0);this.length++},getBuffer:function(){var bytes=[],val=0;for(var i=0;i<this.length;i++){val=(val<<1)|this.buffer[i];if(i%8==7){bytes.push(val);val=0}}if(this.length%8!=0)bytes.push(val<<(8-this.length%8));return bytes}}
  function QRCode(typeNumber, errorCorrectLevel){this.typeNumber=typeNumber;this.errorCorrectLevel=errorCorrectLevel;this.modules=null;this.moduleCount=0;this.dataList=[]}
  QRCode.prototype={addData:function(data){this.dataList.push(new QR8bitByte(data))},make:function(){
    // fixed to typeNumber 4 (33x33) for small payloads (hash)
    this.typeNumber=4; this.moduleCount = 33; this.modules = new Array(this.moduleCount);
    for(var row=0;row<this.moduleCount;row++){this.modules[row]=new Array(this.moduleCount);for(var col=0;col<this.moduleCount;col++)this.modules[row][col]=null}
    function pl(qr, row, col){for(var r=-1;r<=7;r++){if(row+r<=-1||qr.moduleCount<=row+r)continue;for(var c=-1;c<=7;c++){if(col+c<=-1||qr.moduleCount<=col+c)continue;qr.modules[row+r][col+c]=(r>=0&&r<=6&&(c==0||c==6))||(c>=0&&c<=6&&(r==0||r==6))||(r>=2&&r<=4&&c>=2&&c<=4)}}}
    pl(this,0,0); pl(this,this.moduleCount-7,0); pl(this,0,this.moduleCount-7);
    // timing patterns
    for(var i=8;i<this.moduleCount-8;i++){this.modules[6][i]=(i%2==0);this.modules[i][6]=(i%2==0)}
    // data
    var bb=new QRBitBuffer();
    for(var i=0;i<this.dataList.length;i++){var data=this.dataList[i];bb.put(QRMode.MODE_8BIT_BYTE,4);bb.put(data.getLength(),8);data.write(bb)}
    // error correction (short simplified): pad to fit
    var dataBytes=bb.getBuffer(); while(dataBytes.length<80) dataBytes.push(0xec,0x11);
    // place data (very simplified zig-zag)
    var inc=-1,row=this.moduleCount-1,bit=0,byte=0; for(var col=this.moduleCount-1; col>0; col-=2){
      if(col==6) col--;
      while(true){
        for(var c=0;c<2;c++){ if(this.modules[row][col-c]==null){var dark=((dataBytes[byte]>>> (7-bit)) & 1)==1; this.modules[row][col-c]=dark; bit++; if(bit==8){bit=0;byte++}}}
        row+=inc; if(row<0||this.moduleCount<=row){row-=inc; inc=-inc; break;}
      }
    }
  },isDark:function(row,col){return this.modules[row][col]}};
  function drawQR(canvas, text, size){
    var qr=new QRCode(4,QRErrorCorrectLevel.L); qr.addData(text); qr.make();
    var ctx=canvas.getContext('2d'); var count=qr.moduleCount; var scale=Math.floor(size/count);
    canvas.width = canvas.height = count*scale;
    ctx.fillStyle='#000'; ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle='#fff'; ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle='#000';
    for(var r=0;r<count;r++) for(var c=0;c<count;c++) if(qr.isDark(r,c)) ctx.fillRect(c*scale,r*scale,scale,scale);
  }
  window._cp_drawQR = drawQR;
})();

// Glue: add QR of full document hash into Composite (if toggled)
async function addQrToComposite(fullHash){
  if(!document.getElementById('qrToggle')?.checked) return;
  const canvas = document.createElement('canvas'); canvas.id='qrDocHash';
  canvas.style.marginTop='8px';
  const h3 = document.createElement('h3'); h3.textContent='Verification QR (doc hash)';
  _cp_drawQR(canvas, fullHash, 256);
  const el = document.getElementById('printArea'); el.appendChild(h3); el.appendChild(canvas);
}
// Hook our earlier hash appender to also add QR
const __buildComposite = buildComposite;
buildComposite = async function(){
  await __buildComposite();
  const full = await computeDocHash();
  await addQrToComposite(full);
};

// ===== Policy editor helpers =====
document.getElementById('btnAddPromptIn').addEventListener('click', ()=>{
  try{
    const obj = JSON.parse(document.getElementById('policyJson').value);
    obj.inpatient = obj.inpatient || {}; obj.inpatient.admission_prompts = obj.inpatient.admission_prompts || [];
    obj.inpatient.admission_prompts.push({id: 'custom_'+Date.now(), label: 'New inpatient prompt'});
    document.getElementById('policyJson').value = JSON.stringify(obj, null, 2);
  }catch(e){ alert('Invalid JSON — fix it first.'); }
});
document.getElementById('btnAddPromptOut').addEventListener('click', ()=>{
  try{
    const obj = JSON.parse(document.getElementById('policyJson').value);
    obj.outpatient = obj.outpatient || {}; obj.outpatient.initial_prompts = obj.outpatient.initial_prompts || [];
    obj.outpatient.initial_prompts.push({id: 'custom_'+Date.now(), label: 'New outpatient prompt'});
    document.getElementById('policyJson').value = JSON.stringify(obj, null, 2);
  }catch(e){ alert('Invalid JSON — fix it first.'); }
});
document.getElementById('btnRemoveLastPrompt').addEventListener('click', ()=>{
  try{
    const obj = JSON.parse(document.getElementById('policyJson').value);
    const wf = (document.getElementById('workflowSel').value==='inpatient') ? 'inpatient' : 'outpatient';
    const key = wf==='inpatient' ? 'admission_prompts' : 'initial_prompts';
    const arr = obj[wf] && obj[wf][key]; if(Array.isArray(arr) && arr.length){ arr.pop(); }
    document.getElementById('policyJson').value = JSON.stringify(obj, null, 2);
  }catch(e){ alert('Invalid JSON — fix it first.'); }
});

// ===== File-naming wizard =====
function computeSuggestedName(){
  const d = cp.state.data;
  const parts = [];
  const nm = (d.patient.name||'patient').trim().replace(/\s+/g,'_');
  const mrn = (d.patient.mrn||'').trim().replace(/\s+/g,'_');
  const date = new Date().toISOString().slice(0,10);
  const wf = (cp.state.workflow||'wf');
  const st = (cp.state.episodeState||'state');
  if(mrn) parts.push(mrn); else parts.push(nm);
  parts.push(wf); parts.push(st); parts.push(date);
  return parts.join('_') + '_CarePlan.json.enc';
}
function refreshSuggestedName(){
  document.getElementById('suggestName').textContent = computeSuggestedName();
}
document.getElementById('btnCopyName').addEventListener('click', async ()=>{
  await navigator.clipboard.writeText(document.getElementById('suggestName').textContent);
  alert('Suggested file name copied.');
});

// Hook into existing flows
const ___markDirty = markDirty;
markDirty = function(){ ___markDirty(); refreshSuggestedName(); };
document.addEventListener('DOMContentLoaded', refreshSuggestedName);

// Also use suggested name for bundle export
// Safe wrapper for exportEncryptedBundle
const __exportEncryptedBundle = (typeof exportEncryptedBundle === 'function')
  ? exportEncryptedBundle
  : async function(){};   // no-op fallback

exportEncryptedBundle = async function(){
  if(document.getElementById('requirePass').checked && !cp.state.passphraseSet){
    alert('Set a passphrase first (Security bar).');
    return;
  }
  const pack = await encryptJSON(PASSPHRASE || 'demo', cp.state.data);
  const filename = computeSuggestedName();
  const blob = new Blob([JSON.stringify(pack,null,2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1500);
  audit('export_bundle', filename);
};
</script>
</div><!-- /container -->

<!-- Merge + Diff Patch -->
<div id="mergeDlg" class="no-print hidden" style="position:fixed;inset:0;background:rgba(0,0,0,.4);display:flex;align-items:center;justify-content:center;z-index:2000">
  <div style="background:#fff;max-width:800px;width:95%;border-radius:12px;border:1px solid #e5e7eb;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.2)">
    <h3>Import detected changes — Merge required</h3>
    <div id="mergeInfo" class="pill" style="margin:6px 0"></div>
    <div class="row">
      <div class="col-6">
        <label class="pill"><input type="radio" name="m_patient" value="theirs"> Patient (use imported)</label>
        <label class="pill"><input type="radio" name="m_patient" value="mine" checked> Patient (keep mine)</label><br>
        <label class="pill"><input type="radio" name="m_admission" value="theirs"> Admission (use imported)</label>
        <label class="pill"><input type="radio" name="m_admission" value="mine" checked> Admission (keep mine)</label><br>
        <label class="pill"><input type="radio" name="m_risk" value="theirs"> Risk (use imported)</label>
        <label class="pill"><input type="radio" name="m_risk" value="mine" checked> Risk (keep mine)</label><br>
        <label class="pill"><input type="radio" name="m_discharge" value="theirs"> Discharge (use imported)</label>
        <label class="pill"><input type="radio" name="m_discharge" value="mine" checked> Discharge (keep mine)</label><br>
        <label class="pill"><input type="radio" name="m_prompts" value="theirs"> Policy prompts (use imported)</label>
        <label class="pill"><input type="radio" name="m_prompts" value="mine" checked> Policy prompts (keep mine)</label><br>
      </div>
      <div class="col-6">
        <label class="pill"><input type="checkbox" id="m_reviews_merge" checked> Reviews — auto-merge</label><br>
        <label class="pill"><input type="checkbox" id="m_audit_merge" checked> Audit — auto-merge</label><br>
        <label class="pill"><input type="radio" name="m_icp" value="theirs"> ICP — use imported</label>
        <label class="pill"><input type="radio" name="m_icp" value="mine" checked> ICP — keep mine</label><br>
        <label class="pill"><input type="radio" name="m_meds" value="theirs"> Medications — use imported</label>
        <label class="pill"><input type="radio" name="m_meds" value="mine" checked> Medications — keep mine</label>
      </div>
    </div>
    <div class="stack" style="margin-top:10px">
      <button class="btn" id="btnMergeApply">Preview & Apply</button>
      <button class="btn secondary" id="btnMergeCancel">Cancel</button>
    </div>
    <pre id="mergePreview" style="max-height:180px;overflow:auto;background:#f8fafc;border:1px solid #e5e7eb;border-radius:8px;padding:8px;margin-top:8px"></pre>
  </div>
</div>
<div class="card no-print" style="margin:12px">
  <h2>Admin: Compare Bundles (Diff)</h2>
  <div class="row">
    <div class="col-6"><label>Bundle A</label><input type="file" id="diffFileA" accept=".json,.enc,application/json"></div>
    <div class="col-6"><label>Bundle B</label><input type="file" id="diffFileB" accept=".json,.enc,application/json"></div>
  </div>
  <div class="stack" style="margin-top:8px"><button class="btn secondary" id="btnComputeDiff">Compute Diff</button></div>
  <pre id="diffOutput" style="max-height:220px;overflow:auto;background:#f8fafc;border:1px solid #e5e7eb;border-radius:8px;padding:8px;margin-top:8px"></pre>
</div>

<script>
(function(){
  // Elements
  const brandingBar = document.getElementById('brandingBar');
  const hseLogo = document.getElementById('hseLogo');
  const partnerLogo = document.getElementById('partnerLogo');

  // Admin controls (may not exist if Admin panel not present yet)
  const logoUrl = document.getElementById('brandLogoUrl');
  const logoVariant = document.getElementById('brandLogoVariant');
  const bilingualSel = document.getElementById('brandBilingual');
  const svcInput = document.getElementById('serviceNameInputAdmin');

  function loadBrand(){
    const b = (window.cp?.state?.brand) || {};
    // header/logo
    const url = b.logoUrl || '';
    if(url){
      brandingBar.style.display = 'flex';
      hseLogo.src = url;
      hseLogo.style.filter = (b.variant==='white') ? 'brightness(0) invert(1)' : 'none';
    }else{
      brandingBar.style.display = 'none';
    }
    // admin UI
    if(logoUrl) logoUrl.value = url;
    if(logoVariant) logoVariant.value = b.variant || 'green';
    if(bilingualSel) bilingualSel.value = b.bilingual === 'on' ? 'on' : 'off';
  }

  async function saveBrand(){
    if(!window.cp) window.cp={state:{}};
    if(!window.cp.state) window.cp.state={};
    const b = window.cp.state.brand = window.cp.state.brand || {};
    if(logoUrl) b.logoUrl = logoUrl.value.trim();
    if(logoVariant) b.variant = logoVariant.value;
    if(bilingualSel) b.bilingual = bilingualSel.value;
    if(typeof markDirty==='function') markDirty();
    if(typeof saveEncrypted==='function') await saveEncrypted();
    loadBrand();
    alert('Brand settings saved.');
  }

  // Attach events if fields exist
  if(logoUrl){ logoUrl.addEventListener('change', saveBrand); }
  if(logoVariant){ logoVariant.addEventListener('change', saveBrand); }
  if(bilingualSel){ bilingualSel.addEventListener('change', saveBrand); }

  document.addEventListener('DOMContentLoaded', loadBrand);

  // Patch print header builder to include logo + bilingual heading
  async function addPrintHeaderFooter(){
    const area = document.getElementById('printArea'); if(!area) return;
    area.querySelector('#printHeader')?.remove();
    document.getElementById('printFooter')?.remove();

    const header = document.createElement('div'); header.id = 'printHeader';
    const now = new Date();
    const svc = (window.cp?.state?.serviceName) || 'HSE Service';
    const pat = (window.cp?.state?.data?.patient?.name) || 'Patient';
    const hashEl = document.getElementById('docHash');
    const hashShort = hashEl ? hashEl.textContent : '';

    const b = (window.cp?.state?.brand)||{};
    const bilingual = b.bilingual === 'on';

    const leftLogo = b.logoUrl ? `<img alt="HSE" src="${b.logoUrl}" style="height:28px;vertical-align:middle;${b.variant==='white'?'filter:brightness(0) invert(1);':''}">` : '';
    const title = bilingual ? '<strong>Plean Cúram / Care Plan</strong><br><span style="color:#64748b">Doiciméad Comhdhéanta / Composite ICP</span>'
                            : '<strong>Care Plan</strong><br><span style="color:#64748b">Composite ICP</span>';

    header.innerHTML = `<div style="display:flex;align-items:center;gap:10px">
                          ${leftLogo}
                          <div><div style="font-size:11pt">${svc}</div>${title}</div>
                        </div>
                        <div style="text-align:right">
                          <div>${now.toLocaleDateString()} ${now.toLocaleTimeString()}</div>
                          <div style="color:#64748b">Doc hash ${hashShort}</div>
                        </div>`;
    area.prepend(header);

    const footer = document.createElement('div'); footer.id = 'printFooter';
    footer.innerHTML = `<div style="display:flex;justify-content:space-between">
        <span>Generated by CarePlanner</span>
        <span style="color:#64748b">For: ${pat}</span>
      </div>`;
    document.body.appendChild(footer);
  }

  // If buildComposite is available, wrap it once
  if(typeof buildComposite === 'function' && !window.__printHeaderPatched){
    const _bc = buildComposite;
    buildComposite = async function(){
      const res = await _bc();
      await addPrintHeaderFooter();
      return res;
    };
    window.__printHeaderPatched = true;
  } else {
    document.addEventListener('DOMContentLoaded', addPrintHeaderFooter);
  }
})();
</script>


<script>
(function(){
  const brandingBar = document.getElementById('brandingBar');
  const hseLogo = document.getElementById('hseLogo');
  const logoUrl = document.getElementById('brandLogoUrl');
  const logoVariant = document.getElementById('brandLogoVariant');
  const bilingualSel = document.getElementById('brandBilingual');
  const fileInput = document.getElementById('brandLogoUpload');
  const sourceRadios = document.getElementsByName('brandLogoSource');

  function getBrand(){ return (window.cp?.state?.brand) || {}; }
  function ensureBrand(){ if(!window.cp) window.cp={state:{}}; if(!window.cp.state) window.cp.state={}; if(!window.cp.state.brand) window.cp.state.brand={}; return window.cp.state.brand; }

  function currentSource(){
    const b = getBrand();
    return b.source || 'url';
  }

  function applyBrandToHeader(){
    const b = getBrand();
    let src = '';
    if((b.source||'url') === 'uploaded' && b.logoData){ src = b.logoData; }
    else if(b.logoUrl){ src = b.logoUrl; }
    if(src){
      brandingBar.style.display = 'flex';
      hseLogo.src = src;
      hseLogo.style.filter = (b.variant==='white') ? 'brightness(0) invert(1)' : 'none';
    }else{
      brandingBar.style.display = 'none';
    }
  }

  async function saveAndApply(){
    const b = ensureBrand();
    if(logoUrl) b.logoUrl = logoUrl.value.trim();
    if(logoVariant) b.variant = logoVariant.value;
    if(bilingualSel) b.bilingual = bilingualSel.value;
    // source radio
    for(const r of sourceRadios||[]){ if(r.checked) b.source = r.value; }
    if(typeof markDirty==='function') markDirty();
    if(typeof saveEncrypted==='function') await saveEncrypted();
    applyBrandToHeader();
  }

  // Load initial UI values
  function loadBrandUI(){
    const b = getBrand();
    if(logoUrl) logoUrl.value = b.logoUrl || '';
    if(logoVariant) logoVariant.value = b.variant || 'green';
    if(bilingualSel) bilingualSel.value = b.bilingual === 'on' ? 'on' : 'off';
    if(sourceRadios && sourceRadios.length){
      for(const r of sourceRadios){ r.checked = (r.value === (b.source||'url')); }
    }
    applyBrandToHeader();
  }

  // Handle file upload -> data URI (embedded)
  if(fileInput){
    fileInput.addEventListener('change', async (e)=>{
      const f = e.target.files && e.target.files[0]; if(!f) return;
      const reader = new FileReader();
      reader.onload = async function(){
        const b = ensureBrand();
        b.logoData = reader.result; // data URI
        b.source = 'uploaded';
        if(typeof markDirty==='function') markDirty();
        if(typeof saveEncrypted==='function') await saveEncrypted();
        loadBrandUI();
        alert('Logo embedded for offline use.');
      };
      reader.readAsDataURL(f);
    });
  }

  // Wire changes
  if(logoUrl) logoUrl.addEventListener('change', saveAndApply);
  if(logoVariant) logoVariant.addEventListener('change', saveAndApply);
  if(bilingualSel) bilingualSel.addEventListener('change', saveAndApply);
  if(sourceRadios && sourceRadios.length){
    for(const r of sourceRadios){ r.addEventListener('change', saveAndApply); }
  }

  // Patch print header: prefer embedded data if selected
  async function addPrintHeaderFooter_brandPatch(){
    const area = document.getElementById('printArea'); if(!area) return;
    const b = getBrand();
    const bilingual = b.bilingual === 'on';
    const src = (b.source==='uploaded' && b.logoData) ? b.logoData : (b.logoUrl||'');
    const imgStyle = (b.variant==='white') ? 'filter:brightness(0) invert(1);' : '';

    // Update image in existing print header if present
    const ph = document.getElementById('printHeader');
    if(ph){
      const img = src ? `<img alt="HSE" src="${src}" style="height:28px;vertical-align:middle;${imgStyle}">` : '';
      // naive replace of left header block
      const blocks = ph.children;
      if(blocks && blocks[0]){
        // Rebuild left block with logo + title keeping service name
        const svc = (window.cp?.state?.serviceName) || 'HSE Service';
        const title = bilingual ? '<strong>Plean C\u00FAram / Care Plan</strong><br><span style="color:#64748b">Doicim\u00E9ad Comhdh\u00E9anta / Composite ICP</span>'
                                : '<strong>Care Plan</strong><br><span style="color:#64748b">Composite ICP</span>';
        blocks[0].innerHTML = `<div style="display:flex;align-items:center;gap:10px">${img}<div><div style="font-size:11pt">${svc}</div>${title}</div></div>`;
      }
    }
  }

  document.addEventListener('DOMContentLoaded', loadBrandUI);
  // Also patch after composite build
  document.addEventListener('DOMContentLoaded', ()=>{
    setTimeout(addPrintHeaderFooter_brandPatch, 50);
  });
})();
</script>


<script>
(function(){
  // Augment brand logic to support 'builtin' source
  function getBrand(){ return (window.cp?.state?.brand) || {}; }
  function ensureBrand(){ if(!window.cp) window.cp={state:{}}; if(!window.cp.state) window.cp.state={}; if(!window.cp.state.brand) window.cp.state.brand={}; return window.cp.state.brand; }
  const sourceRadios = document.getElementsByName('brandLogoSource');
  const brandingBar = document.getElementById('brandingBar');
  const hseLogo = document.getElementById('hseLogo');

  const BUILTIN_DATA = 'data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' width=\'360\' height=\'120\' viewBox=\'0 0 360 120\'><rect width=\'100%\' height=\'100%\' fill=\'white\'/><text x=\'50%\' y=\'55%\' dominant-baseline=\'middle\' text-anchor=\'middle\' font-family=\'Arial, Helvetica, sans-serif\' font-size=\'64\' fill=\'%23006152\'>HSE</text><text x=\'50%\' y=\'80%\' dominant-baseline=\'middle\' text-anchor=\'middle\' font-family=\'Arial, Helvetica, sans-serif\' font-size=\'12\' fill=\'%2364758b\'>Placeholder mark for testing</text></svg>';

  function applyBrandToHeader_ext(){
    const b = getBrand();
    let src = '';
    if(b.source==='builtin'){ src = BUILTIN_DATA; }
    else if(b.source==='uploaded' && b.logoData){ src = b.logoData; }
    else if(b.logoUrl){ src = b.logoUrl; }
    if(src){
      brandingBar.style.display = 'flex';
      hseLogo.src = src;
      hseLogo.style.filter = (b.variant==='white') ? 'brightness(0) invert(1)' : 'none';
    }else{
      brandingBar.style.display = 'none';
    }
  }

  function syncRadios(){
    const b = getBrand();
    if(!sourceRadios) return;
    for(const r of sourceRadios){ r.checked = (r.value === (b.source||'url')); }
  }

  // Hook into existing brand functions if present
  document.addEventListener('DOMContentLoaded', ()=>{
    // First apply
    applyBrandToHeader_ext();
    // Then hook any changes to radios
    if(sourceRadios && sourceRadios.length){
      for(const r of sourceRadios){
        r.addEventListener('change', async ()=>{
          const b = ensureBrand(); b.source = r.value;
          if(typeof markDirty==='function') markDirty();
          if(typeof saveEncrypted==='function') await saveEncrypted();
          applyBrandToHeader_ext();
        });
      }
    }
    syncRadios();
  });

  // Also patch print header building after composite render
  document.addEventListener('DOMContentLoaded', ()=>{
    setTimeout(()=>{
      const b = getBrand();
      const src = b.source==='builtin' ? BUILTIN_DATA : (b.source==='uploaded' && b.logoData ? b.logoData : (b.logoUrl||''));
      if(!src) return;
      const ph = document.getElementById('printHeader');
      if(!ph) return;
      const img = `<img alt="HSE" src="${src}" style="height:28px;vertical-align:middle;${b.variant==='white'?'filter:brightness(0) invert(1);':''}">`;
      const blocks = ph.children;
      if(blocks && blocks[0]){
        const left = blocks[0].querySelector('div');
        if(blocks[0]){
          // Prepend/replace left block content with logo
          const current = blocks[0].innerHTML;
          if(current.indexOf('<img') === -1){
            blocks[0].innerHTML = img + current;
          } else {
            // replace existing first <img>
            blocks[0].innerHTML = current.replace(/<img[^>]*>/, img);
          }
        }
      }
    }, 60);
  });
})();
</script>


<!-- Brand Pre‑flight Modal -->
<div id="brandCheckDlg" class="no-print modal-backdrop hidden" role="dialog" aria-modal="true" aria-labelledby="brandCheckTitle">
  <div class="modal" style="max-width:720px">
    <header>
      <h3 id="brandCheckTitle">Brand & Accessibility Check</h3>
      <button class="close" id="brandCheckClose" aria-label="Close">×</button>
    </header>
    <p class="note">We’ll do quick checks based on the HSE visual identity guidance before printing.</p>
    <ul id="brandCheckList" style="margin:8px 0 12px 18px"></ul>
    <label class="pill"><input type="checkbox" id="brandCheckOverride"> Proceed even if there are warnings</label>
    <div class="stack" style="margin-top:10px">
      <button class="btn" id="brandCheckProceed">Proceed to Print</button>
      <button class="btn ghost" id="brandCheckCancel">Cancel</button>
    </div>
  </div>
</div>


<script>
(function(){
  // === Bilingual headings mapping for Composite print ===
  const BIL_MAP = new Map([
    ['Care Plan','Plean C\u00FAram / Care Plan'],
    ['Composite ICP','Doicim\u00E9ad Comhdh\u00E9anta / Composite ICP'],
    ['Patient Details','Sonra\u00ED an Othair / Patient Details'],
    ['Story & Strengths','Sc\u00E9al & L\u00E1idreachta\u00ED / Story & Strengths'],
    ['Goals','Cusp\u00F3ir\u00ED / Goals'],
    ['Interventions','Idirghabh\u00E1il / Interventions'],
    ['Resources','Acmhainn\u00ED / Resources'],
    ['Risks & Safety','Riosca\u00ED & S\u00E1bh\u00E1ilteacht / Risks & Safety'],
    ['Medications','Cogaiseanna / Medications'],
    ['MDT Review','Athbhreithni\u00FA MDT / MDT Review'],
    ['Appointments','Coinnithe / Appointments'],
    ['Linked Services','Seirbh\u00EDs\u00ED Nasctha / Linked Services'],
    ['Discharge Plan','Plean Scaoilte / Discharge Plan'],
    ['Team','Foireann / Team'],
    ['Policy Prompts','Leideanna Beartais / Policy Prompts'],
    ['Audit Trail','Rian Ini\u00FAchta / Audit Trail'],
    ['Summary','Achoimre / Summary']
  ]);

  function applyBilingualHeadings(){
    const b = (window.cp?.state?.brand) || {};
    if(b.bilingual !== 'on') return;
    const area = document.getElementById('printArea'); if(!area) return;
    const hs = area.querySelectorAll('h1,h2,h3,th,caption,.section-title');
    hs.forEach(el=>{
      const t = (el.textContent||'').trim();
      if(BIL_MAP.has(t)){
        el.textContent = BIL_MAP.get(t);
      }
    });
  }

  // Hook after composite build (we already wrap buildComposite elsewhere; add another guard)
  if(typeof buildComposite === 'function' && !window.__bilingualPatched){
    const _bc = buildComposite;
    buildComposite = async function(){
      const res = await _bc();
      applyBilingualHeadings();
      return res;
    };
    window.__bilingualPatched = true;
  } else {
    document.addEventListener('DOMContentLoaded', applyBilingualHeadings);
  }

  // === Brand pre‑flight ===
  const dlg = document.getElementById('brandCheckDlg');
  const list = document.getElementById('brandCheckList');
  const closeBtn = document.getElementById('brandCheckClose');
  const proceedBtn = document.getElementById('brandCheckProceed');
  const cancelBtn = document.getElementById('brandCheckCancel');
  const overrideChk = document.getElementById('brandCheckOverride');

  function luminance(hex){
    const c = hex.replace('#','');
    const r = parseInt(c.substring(0,2),16)/255;
    const g = parseInt(c.substring(2,4),16)/255;
    const b = parseInt(c.substring(4,6),16)/255;
    const a = [r,g,b].map(v=> v<=0.03928 ? v/12.92 : Math.pow((v+0.055)/1.055,2.4));
    return 0.2126*a[0] + 0.7152*a[1] + 0.0722*a[2];
  }
  function contrastRatio(fg,bg){
    try{
      const L1 = luminance(fg), L2 = luminance(bg);
      const light = Math.max(L1,L2), dark = Math.min(L1,L2);
      return (light + 0.05) / (dark + 0.05);
    }catch(e){ return 4.5; }
  }

  function buildChecklist(){
    const items = [];
    const b = (window.cp?.state?.brand) || {};
    const src = (b.source==='uploaded' && b.logoData) ? 'embedded' : (b.source==='builtin' ? 'builtin' : (b.logoUrl ? 'url' : 'none'));
    // 1) Logo present
    if(src==='none'){
      items.push({ok:false, text:'No HSE logo set (URL or embedded).'});
    }else if(src==='builtin'){
      items.push({ok:false, text:'Using built‑in placeholder logo (testing only). Replace with approved HSE logo.'});
    }else{
      items.push({ok:true, text:'HSE logo present ('+src+').'});
    }
    // 2) Variant sanity
    const headerBg = '#ffffff'; // app header is white; print header also white by default
    if(b.variant==='white' && headerBg.toLowerCase()==='#ffffff'){
      items.push({ok:false, text:'Logo variant is "white on colour" but header background is white. Switch to "green" or "black" variant.'});
    }else{
      items.push({ok:true, text:'Logo variant appropriate for background.'});
    }
    // 3) Font
    const fontOK = getComputedStyle(document.documentElement).getPropertyValue('--hse-font').includes('Arial');
    items.push({ok:fontOK, text: fontOK ? 'Typeface is Arial-based.' : 'Typeface not set to Arial. Check branding tokens.'});
    // 4) Contrast for primary button colour vs white
    const green = getComputedStyle(document.documentElement).getPropertyValue('--hse-green').trim() || '#006152';
    const ratio = contrastRatio(green, '#ffffff');
    items.push({ok: ratio>=4.5, text:'Primary button contrast ratio ≈ '+ratio.toFixed(2)+' (needs ≥ 4.5 for AA).'});
    // 5) Bilingual (informational)
    if(b.bilingual==='on'){
      items.push({ok:true, text:'Bilingual print headings: ON.'});
    } else {
      items.push({ok:true, text:'Bilingual print headings: OFF (OK if not required for this output).'});
    }
    // Render
    list.innerHTML = '';
    items.forEach(it=>{
      const li = document.createElement('li');
      li.textContent = (it.ok?'✔︎ ':'⚠︎ ') + it.text;
      li.style.color = it.ok ? '#065f46' : '#b45309';
      list.appendChild(li);
    });
    // Determine if any hard fails (logo none or variant mismatch)
    const hardFail = items.some(it=> it.text.startsWith('No HSE logo') || it.text.indexOf('Switch to "green"')>-1);
    return {items, hardFail};
  }

  function openDlg(){
    const res = buildChecklist();
    dlg.classList.remove('hidden');
    // focus
    setTimeout(()=>{ dlg.querySelector('button, input')?.focus(); }, 0);
    return res;
  }
  function closeDlg(){ dlg.classList.add('hidden'); }

  closeBtn?.addEventListener('click', closeDlg);
  cancelBtn?.addEventListener('click', closeDlg);

  // Intercept Print button to run pre‑flight
  const printBtn = document.getElementById('btnPrint');
  if(printBtn){
    printBtn.addEventListener('click', (ev)=>{
      ev.stopImmediatePropagation();
      ev.preventDefault();
      const {hardFail} = openDlg();
      proceedBtn.onclick = async function(){
        if(hardFail && !overrideChk.checked){
          alert('Please address the highlighted issues or tick "Proceed even if there are warnings".');
          return;
        }
        closeDlg();
        // Build composite and print
        if(typeof buildComposite==='function'){ await buildComposite(); }
        // Block print if high-risk without mitigation/signatures
		const rv4 = cp.state.data.riskV4 || {};
		if (rv4._high) {
		  const ok = (rv4.mitigation||'').trim() && rv4.sign?.med && rv4.sign?.medDate && rv4.sign?.nurse && rv4.sign?.nurseDate;
		  if (!ok) { alert('High-risk present: mitigation + dual sign-off required before printing.'); return; }
		}
        window.print();
      };
    }, true);
  }
})();
</script>
<script>
function setPrintMode(mode) {
  document.getElementById('print-colour').disabled = (mode !== 'colour');
  document.getElementById('print-bw').disabled = (mode !== 'bw');
  window.print();
}
</script>
<script>
  // ---- ONE true logo element
  document.addEventListener('DOMContentLoaded', () => {
    // Remove stray duplicates if they still exist
    document.querySelectorAll('.hse-mark:not(#hseLogo)').forEach(el => el.remove());

    // Set the default on-screen logo (white on green header looks best)
    const logo = document.getElementById('hseLogo');
    if (logo) logo.src = 'assets/hse-logo-white.png'; // or green if you prefer
  });

  // ---- Print mode handling (hooks into your existing Print buttons)
  (function(){
    const body = document.body;
    const logo = () => document.getElementById('hseLogo');

    function doPrint(mode){
      body.setAttribute('data-print', mode);

      // Swap logo for the print
      if (logo()){
        if (mode === 'bw')      logo().src = 'assets/hse-logo-black.png';
        if (mode === 'colour')  logo().src = 'assets/hse-logo-green.png';
      }

      window.print();

      // Restore screen state shortly after the dialog opens
      setTimeout(() => {
        body.removeAttribute('data-print');
        if (logo()) logo().src = 'assets/hse-logo-white.png'; // back to screen default
      }, 300);
    }

    // Wire to your buttons (already present in the Composite panel)
    document.getElementById('btnPrintColour')?.addEventListener('click', () => doPrint('colour'));
    document.getElementById('btnPrintBW')?.addEventListener('click', () => doPrint('bw'));
  })();
</script>

<script>
(function(){
  const body = document.body;
  const logoEl = () => document.getElementById('hseLogo');

  function doPrint(mode){
    body.setAttribute('data-print', mode);
    if (logoEl()){
      logoEl().src = (mode === 'bw')
        ? 'assets/hse-logo-black.png'
        : 'assets/hse-logo-green.png';
    }
    window.print();
    setTimeout(() => {
      body.removeAttribute('data-print');
      if (logoEl()) logoEl().src = 'assets/hse-logo-white.png'; // screen default
    }, 300);
  }

  document.getElementById('btnPrintColour')?.addEventListener('click', () => doPrint('colour'));
  document.getElementById('btnPrintBW')?.addEventListener('click', () => doPrint('bw'));
})();
</script>


</body>
</html>
